version: '2'

services:
    pimp:
        image: pimp:${PIMP_VERSION}
        build: .
        container_name: pimp
        hostname: pimp
        environment:
            - PIMP_DATABASE_HOST=mysql
            - PYTHONUNBUFFERED=1
            - MYSQL_DATABASE
            - MYSQL_USER
            - MYSQL_PASSWORD
        depends_on:
            - mysql
        extends:
            file: common.yml
            service: logging
    mysql:
        environment:
            - MYSQL_ALLOW_EMPTY_PASSWORD=yes
            - MYSQL_DATABASE
            - MYSQL_USER
            - MYSQL_PASSWORD
        image: mysql:${MYSQL_VERSION}
        container_name: mysql
        hostname: mysql
        extends:
            file: common.yml
            service: logging
    nginx:
        container_name: nginx
        hostname: nginx
        volumes_from:
            - pimp
        image: nginx-pimp:${NGINX_VERSION}
        build:
            context: DockerNginxContext
        environment:
            - PIMP_HOSTNAME=pimp
            - EXTERNAL_HOSTNAME
            - EXTERNAL_HOST_AND_PORT
            - NGINX_ERROR_LOGLEVEL
        command: /bin/bash -c "envsubst < /etc/nginx/conf.d/pimp.conf.template > /etc/nginx/conf.d/pimp.conf && nginx -g 'daemon off;'"
        depends_on:
            - pimp
        ports:
            - "${EXTERNAL_PORT}:80"
        extends:
            file: common.yml
            service: logging
    backup:
        image: tutumcloud/mysql-backup
        environment:
            - MYSQL_HOST=mysql
            - MYSQL_PORT=3306
            - MYSQL_USER=pimp
            - MYSQL_PASS=${MYSQL_PASSWORD}
            - MYSQL_DB=pimp
            - CRON_TIME
            - MAX_BACKUPS=30
        depends_on:
            - mysql

