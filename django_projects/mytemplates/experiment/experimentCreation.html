{%  extends 'base_bs3.html' %}

{% load staticfiles %}

{% block custom_scripts_and_styles %}
    <script src="{% static 'jquery-validation-1.14.0/jquery.validate.min.js' %}"></script>
    <script src="{% static 'jquery-validation-1.14.0/additional-methods.min.js' %}"></script>
    <!script src="{% static 'js/group_creation_js.js' %}"><!/script>

<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}/css/project_summary.css" media="screen"/>
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}/css/defaultTheme.css" media="screen" />
<!script src="http://code.jquery.com/jquery-migrate-1.0.0.js"><!/script>
<!script type="text/javascript" src="{{ STATIC_URL }}js/jquery.fixedheadertable.min.js"><!/script>
<!script type="text/javascript" src="{{ STATIC_URL }}js/table.js"><!/script>
<!script type="text/javascript" src="{{ STATIC_URL }}js/dragndrop.js"><!/script>
<!script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui-1.10.0.custom.min.js"><!/script>
<script type="text/javascript">
$(document).ready(function() {

  var previous;
  var combination = {};
  var i = 0;
  var data = jQuery.parseJSON('{{ ref|safe }}');
  // This calculate the possible combination for the comparisons, there is a maximum number of comparison which correspond to all condition compared to each other in all the experiments. Comparisons can only be created between conditions of the same experiment.
  for (dataCount = data.length; i < dataCount; i++) {
    data[i].forEach(function(j , el){
      combination[j] = [];
    });
  }
  console.log(combination);

  $('#id_attributes-0-attribute2').empty();

  function removeByValue(arr, val) {
    for(var i=0; i<arr.length; i++) {
        if(arr[i] == val) {
            arr.splice(i, 1);
            break;
        }
    }
}

  function changeOptionSelected(element) {	
	  var str = "";

    console.log("previous: "+previous)
    var selectId = $(element).attr('id');
    var selectedOption = $('#' + selectId + ' option:selected')[0];
    var value = $(selectedOption).val();
    var selectFirst = $(element).parent().parent().find('select')[0];
    var selectToFill = $(element).parent().parent().find('select')[1];
    var titleField = $(element).parent().parent().find('input')[0];
    console.log("value: "+value);

    // if the "select" element is not the 2nd element "select" of the comparison div
    if (selectId != $(selectToFill).attr('id') && value != "select"){
      var i = 0;
      var list = new Array();
      var data = jQuery.parseJSON('{{ ref|safe }}');
      for (dataCount = data.length; i < dataCount; i++) {
        data[i].forEach(function(j , el){
          if (j == value){
            list = data[i];
          }
        });
      }
      if (previous != "select"){
        var valueSecond = selectToFill.value;
        if (valueSecond != "select"){
          removeByValue(combination[valueSecond],previous);
          removeByValue(combination[previous],valueSecond);
          $('.item').each(function(){
            var selectListFirst = $(this).find('select')[0];
            var selectListSecond = $(this).find('select')[1];
            if (selectListFirst.value == previous){
              if ($(selectListSecond).attr('id') != $(selectToFill).attr('id')){
                $(selectListSecond).find('option[value="' + valueSecond + '"]').attr('disabled',false);
              }
            }
            if (selectListFirst.value == valueSecond){
              $(selectListSecond).find('option[value="' + previous + '"]').attr('disabled',false);
            }
          });
          console.log("value: "+valueSecond+" List: " + combination[valueSecond]);
          console.log("value: "+previous+" List: " + combination[previous]);
        }
      }
      // delete every option in the 2nd select
      $(selectToFill).empty();
      // fill 2nd "select" element with all option except the one selected in the first "select" element
      list.forEach(function(j, el){
        if (j != value){
          var text = $('option[value="' + j + '"]').html();
          var opt = $('<option value="' + j + '">' + text + '</option>');
          opt.appendTo(selectToFill);
        }
      });
      var opt = $('<option value="select" selected="selected">Select control</option>');
      opt.appendTo(selectToFill);

      combination[value].forEach(function(j, el){
        console.log("JE SUIS LA!!!! "+j);
        $(selectToFill).find('option[value="' + j + '"]').attr('disabled','disabled');
      });
      // end of fill
      // create comparison title
      $(titleField).val($(selectedOption).html().split(" ")[0] + ' - ');
      // if default select option exist in the first "select element", remove it so the user cannot choose it anymore
      if ($('#' + selectId + ' option[value="select"]').length){
        $('#' + selectId + ' option[value="select"]').remove();
      }
    }
    // if the "select" element is the seconde of the comparison div
    else {
      var valueFirst = selectFirst.value;
      // if default select option exist, remove it so the user cannot choose it anymore
      if ($('#' + selectId + ' option[value="select"]').length){
        $('#' + selectId + ' option[value="select"]').remove();
      }
      if (previous == "select"){
        console.log("select First: "+valueFirst);
        combination[valueFirst].push(value);
        combination[value].push(valueFirst);
        console.log("value: "+valueFirst+" List: " + combination[valueFirst]);
        console.log("value: "+value+" List: " + combination[value]);
        $('.item').each(function(){
          var selectListFirst = $(this).find('select')[0];
          var selectListSecond = $(this).find('select')[1];
          if (selectListFirst.value == valueFirst){
            if ($(selectListSecond).attr('id') != $(selectToFill).attr('id')){
              $(selectListSecond).find('option[value="' + value + '"]').attr('disabled','disabled');
            }
          }
          if (selectListFirst.value == value){
            $(selectListSecond).find('option[value="' + valueFirst + '"]').attr('disabled','disabled');
          }
        });
      }
      else {
        removeByValue(combination[valueFirst],previous);
        removeByValue(combination[previous],valueFirst);
        combination[valueFirst].push(value);
        combination[value].push(valueFirst);
        $('.item').each(function(){
          var selectListFirst = $(this).find('select')[0];
          var selectListSecond = $(this).find('select')[1];
          if (selectListFirst.value == valueFirst){
            if ($(selectListSecond).attr('id') != $(selectToFill).attr('id')){
              $(selectListSecond).find('option[value="' + previous + '"]').attr('disabled',false);
              $(selectListSecond).find('option[value="' + value + '"]').attr('disabled','disabled');
            }
          }
          if (selectListFirst.value == previous){
              $(selectListSecond).find('option[value="' + valueFirst + '"]').attr('disabled',false);
            }
          if (selectListFirst.value == value){
            $(selectListSecond).find('option[value="' + valueFirst + '"]').attr('disabled','disabled');
          }
        });
        console.log("value: "+valueFirst+" List: " + combination[valueFirst]);
        console.log("value: "+value+" List: " + combination[value]);
      }
      // create comparison title
      text = $(titleField).val().split(" ");
      // TODO : replace by this $(selectedOption).text().split(' ').join('_')
      // $(titleField).val(text[0] + "_" + text[1] + "_" + $(selectedOption).text().split(' ')[0]);
      $(titleField).val(text[0] + text[1] + $(selectedOption).text().split(' ')[0]);
    }
    // if option selected is default select option empty second select (normally never happend, just in case)
    if (value == "select"){
      $(selectToFill).empty();
    }
    // remove the focus on the element selected (used to create "previous" on the next focus) !Important
    $(element).blur();
    return false
  }

  function updateElementIndex(el, prefix, ndx) {
    var id_regex = new RegExp('(' + prefix + '-\\d+-)');
    var replacement = prefix + '-' + ndx + '-';
    if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex,replacement));
    if (el.id) el.id = el.id.replace(id_regex, replacement);
    if (el.name) el.name = el.name.replace(id_regex, replacement);
  }

  function deleteForm(btn, prefix) {
    var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());

    if (formCount > 1) {
      // Delete the item/form
      $(btn).parents('.item').slideUp("normal", function() {
        // dropdown list management
        var selectFirst = $(this).find('select')[0];
        var selectSecond = $(this).find('select')[1];
        var valueFirst = selectFirst.value;
        var valueSecond = selectSecond.value;
        if (valueFirst != 'select' && valueSecond != 'select'){
          removeByValue(combination[valueFirst],valueSecond);
          removeByValue(combination[valueSecond],valueFirst);
          $('.item').each(function(){
            var selectListFirst = $(this).find('select')[0];
            var selectListSecond = $(this).find('select')[1];
            if (selectListFirst.value == valueSecond){
              $(selectListSecond).find('option[value="' + valueFirst + '"]').attr('disabled',false);
            }
            if (selectListFirst.value == valueFirst){
              $(selectListSecond).find('option[value="' + valueSecond + '"]').attr('disabled',false);
            }
          });
        }
        // end of dropdown list management
        $(this).remove();
        var forms = $('.item'); // Get all the forms
        // Update the total number of forms (1 less than before)
        $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
        // $(btn).parents('.item').remove();
        var i = 0;
        // Go through the forms and set their indices, names and IDs
        for (formCount = forms.length; i < formCount; i++) {
          $(forms.get(i)).children().children().each(function() {
            updateElementIndex(this, prefix, i);
          });
        }

      });


    } // End if
    else {
        $('#myModal').modal();
    }
    return false;
  }

  function addForm(btn, prefix) {
    var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
    var maxFormCount = parseInt($('#id_' + prefix + '-MAX_NUM_FORMS').val());
    // You can only submit a maximum of 10 todo items 
    if (formCount < maxFormCount) {
      // Clone a form (without event handlers) from the first form
      var row = $(".item:first").clone(false).get(0);
      // Insert it after the last form
      $(row).removeAttr('id').hide().insertAfter(".item:last").slideDown(400);
      // Remove the bits we don't want in the new row/form
      // e.g. error messages
      $(".errorlist", row).remove();
      $(row).children().removeClass('error');
      
      // Relabel/rename all the relevant bits
      var first = true; 
      $(row).children().children().each(function() {
        // alert($(this).is("select"));
        
        updateElementIndex(this, prefix, formCount);
        if ( $(this).attr('type') == 'text' )
          $(this).val('');
        if ( $(this).is("select") && !first){
          $(this).empty();
          // Connect the new select to change function
          $(this).change(function () {
            return changeOptionSelected(this);
          });
          // connect the new select to focus function 
          $(this).focus(function(){
            previous = this.value;
          });
        }
        if ( $(this).is("select") && first){
          first = false;
          if (!$('#' + $(this).attr('id') + ' option[value="select"]').length){
            var opt = $('<option value="select" selected="selected">select member</option>');
            opt.appendTo(this);
          }
          // Connect the new select to change function
          $(this).change(function () {
            return changeOptionSelected(this);
          });
          // connect the new select to focus function 
          $(this).focus(function(){
            previous = this.value;
          });
        }
      });
      
      // Add an event handler for the delete item/form link 
      $(row).find('.delete').click(function() {
        return deleteForm(this, prefix);
      });

      // Update the total form count
      $('#id_' + prefix + '-TOTAL_FORMS').val(formCount + 1); 

    } // End if
    else {
      modalBody = $('#myModalEmpty').find('.modal-body')[0];
      $(modalBody).empty();
      var text = $('<p>Every possible comparison is already there, the calculated max number of comparison is ' + maxFormCount + ', no duplication allowed!');
      text.appendTo(modalBody);
      $('#myModalEmpty').modal();
    }
    return false;
  }

  // this function isn't used anymore with bootstrap 3, to be removed ------------------------------------------------
  function settingsPanel() {
    // if setting panel not show
    if (!Panel) {
      // slide comparison panel to the left
      $('#comparisonPanel').css("float","left");

      // display setting panel (animate dosen't work, look at "isotope.metafizzy.co")
      $('#comparisonPanel').animate({
        "float": "left",
      }, 100, function(){
        $('#settinsPanel').fadeIn();
      });
      Panel = true;
    }
    else {
      // if setting display, hide and center comparison panel
      $('#settinsPanel').fadeOut(300, function(){
        $('#comparisonPanel').css("float","none");
      });
      Panel = false;
    }
  }
  // End this function isn't used anymore with bootstrap 3, to be removed ---------------------------------------------

  // Register the click event handlers
  $(".add_comparison").click(function() {
    console.log("blabla");
    // return addForm(this, 'attributes');
  });
  
  $(".delete").click(function() {
    return deleteForm(this, 'attributes');
  });

  $("#advancedSettings").click(function() {
    return settingsPanel();
  });

  // Register the focus event handlers
  $("select").focus(function(){
    previous = this.value;
  });

  // Register the change event handlers
  $("select").change(function () {
    return changeOptionSelected(this);
  });

  // set up connection between switch buttons and text field in setting panel
  $('input[type="checkbox"]').each(function(){
    console.log($(this).parent().parent().parent().find('label')[0]);
    if ($($(this).parent().parent().parent().find('label')[0]).text() != "iqr") {
      $(this).prop('checked', true);
    }
  });

  $(".parameter-unit").each(function(){
    var checkbox = $(this).find('input[type="checkbox"]');
    // console.log(checkbox)
    if ($(checkbox).length) {
      var valueField = $(this).find('input[type="text"]');
      if ($(checkbox).is(':checked')){
        // $(checkbox).attr("value",true)
        $(valueField).css("display","inline-block");
      }
      else{
        $(valueField).css("display","inline-block");
        $(valueField).prop('disabled', true);
      }
      $(checkbox).change(function (){
        if ($(checkbox).is(':checked')){
          // $(valueField).fadeIn();

          $(valueField).prop('disabled', false);
        }
        else{
          $(valueField).prop('disabled', true);
          // $(valueField).fadeOut();
        }
      });
    }
  });


  // $(".parameter-unit:first").css("margin-left",$(".parameter-unit:last").css("margin-left"));

  var Panel = false;

  $('#experiment_creat').submit(function() { // catch the form's submit event
    //delete one form 'attribute sample' (first one to initialize)
    // deleteFormAttributeSample('samplesattributes');
    //fill attribute sample form with good values
    // fillAttributeSampleForms();
    $.ajax({ // create an AJAX call...
        data: $(this).serialize(), // get the form data
        type: $(this).attr('method'), // GET or POST
        url: $(this).attr('action'), // the file to call
        success: function(response) { // on success..
            // console.log("response");
            location.href = "{% url 'project_detail' project.id %}"
            // alert("ici");
       }
        //    $('#DIV_CONTAINING_FORM').html(response); // update the DIV
        //}
    });
    return false;
      //});
      //alert($(this).serialize());
      //alert($(this).attr('method'));
      //alert($(this).attr('action'));
  });

});
</script>
{% endblock %}

{% block content %}
{% if user.is_authenticated %}
{% ifnotequal permission 'read' %}
<div class="row">
  <div class="col-md-12">
    <div class="page-header">
      <div class="row">
        <div class="col-md-8">
          <h1>{{ project }}</h1>
        </div>
        <div class="col-md-4">
          <a class="btn btn-danger btn-create-project" href="#myModalCancel" role="button" data-toggle="modal">Cancel</a>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <p class="lead">Create a new analysis defining the comparions of your experimental conditions and changing the parameters </p>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
	<div class="container-fluid">
		<form id="experiment_creat" method="POST" action="{% url 'create_experiment' project.id %}" enctype="multipart/form-data">{% csrf_token %}	
    {{ comparison_formset.management_form }}
    {{ parameter_formset.management_form }}
  		<div id="first-step" class="row">
  			<div class="col-md-12">
  				<div class="row">
            <div class="col-md-6 description-span">

              <!-- Enter analysis section -->
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">1. Enter analysis title</h4>
                </div>
                <div class="panel-body">
                  <div class="form-group">
                    <label for="id_title" style="display: none;" generated="true" class="error"></label>
                    {{ experiment_form.title.errors }}
                    {{ experiment_form.title }}
                  </div>
                </div>
              </div>
              <!-- End enter analysis section -->

              <!-- Create new comparisons section -->
              <div class="panel panel-default" id="create_attributes_step">
                <div class="panel-heading">
                  <h4 class="panel-title">2. Add new comparisons</h4>
                </div>
                <div class="panel-body">
                  <p>Select your experimental condition on the panel below to create your first comparison and click the <span class="glyphicon glyphicon-plus"></span> button to add new comparisons to your analysis.</p>
                </div>
              </div>
              <!-- End create new comparisons section -->

              <!-- New comparison form section-->
              {% for form in comparison_formset.forms %}
              <div class="panel panel-info attribute" id="comparison_{{ forloop.counter }}">
                <div class="panel-heading clearfix">
                  <div class="btn-group pull-right">
                    <button data-toggle="tooltip" data-container="body" title="" class="btn btn-sm btn-default delete_comparison" data-original-title="Remove comparison">
                      <span class="glyphicon glyphicon-minus"></span>
                    </button>
                    <button data-toggle="tooltip" data-container="body" title="" class="btn btn-sm btn-default add_comparison" data-original-title="Add comparison">
                      <span class="glyphicon glyphicon-plus"></span>
                    </button>
                  </div>
                  <h2 class="panel-title" style="padding-top:5px;">Comparison {{ forloop.counter }}</h2>
                </div>
                <div class="panel-body form-horizontal">
                  <ol></ol>
                    {{ form.name }}
                  <div class="form-group">
                    <label class="col-md-2 control-label">Condition</label>
                    <div class="col-md-10">
                      {{ form.attribute1 }}
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-md-2 control-label">Control</label>
                    <div class="col-md-10">
                      {{ form.attribute2 }}
                    </div>
                  </div>
                </div>
                <input class="form-control" id="id_attributes-0-name" maxlength="150" name="attributes-0-name" placeholder="Condition name" type="text" style="display: none;">
              </div>
              {% endfor %}
              <!-- End new comparison form section-->
            </div>

              
            <div class="col-md-6">
              <!-- Advanced parameter section -->
              <div class="panel panel-default" id="create_attributes_step">
                <div class="panel-heading" role="tab" id="headingOne">
                  <h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">3. Change Parameters</a><span class="pull-right" style="font-size:14px;">Advanced user only</span></h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse" aria-expanded="false" role="tabpanel" aria-labelledby="headingOne">
                  <div class="panel-body">
                    <p>This form has been populated with default parameters, you can change them manually</p>
                    {% for form in parameter_formset.forms %}
                    <div class="col-md-12 parameter-unit form-horizontal">
                      <div class="form-group">
                        <label class="col-md-4">{{ form.value.label_tag }}</label>
                        {% if form.value.label != "mindetection" and form.value.label != "rtwindow" and form.value.label != "ppm" %}
                        <div class="col-md-8 description-span">
                          <div class="onoffswitch">
                            {{ form.state }}
                            <label class="onoffswitch-label" for="{{ form.state.auto_id }}">
                              <div class="onoffswitch-inner"></div>
                              <div class="onoffswitch-switch"></div>
                            </label>
                          </div>
                        </div>
                        {% else %}
                        <div class="col-md-8 description-span" style="display:none;">
                          <div class="onoffswitch">
                            {{ form.state }}
                            <label class="onoffswitch-label" for="{{ form.state.auto_id }}">
                              <div class="onoffswitch-inner"></div>
                              <div class="onoffswitch-switch"></div>
                            </label>
                          </div>
                        </div>
                        {% endif %}
                        {% if form.value.label != "rt.alignment" %}
                        <div class="col-md-8">
                          {{ form.value.errors }}
                          {{ form.value }}
                        </div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="parameterName">
                      {{ form.name }}
                    </div>
                    {% endfor %}
                    <div class="col-md-12 parameter-unit">
                      {{ database_form }}
                    </div>
                  </div>
                </div>
              </div>
              <!-- Advanced parameter section -->

              <!-- Save form section -->
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">4. Save </h4>
                </div>
                <div class="panel-body">
                  <p>When you are done, click the "Save" button below to store your changes.</p>
                  <button type="submit" class="btn btn-default">Save</button>
                </div>
              </div>
              <!-- End save form section -->

            </div>
              
          </div>
  			</div>
		  </div>

      <!-- Old save button to remove -->
  		<div class="row">
    		<div class="col-md-12"><input class="btn btn-success btn-create-project" type="submit" value="Create experiment"/></div>
  		</div>
      <!-- End Old save button to remove -->
    </form>
	</div>
</div>
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Warning!</h3>
  </div>
  <div class="modal-body">
    <p>You have to enter at least one comparison! </p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>
<div id="myModalEmpty" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Warning!</h3>
  </div>
  <div class="modal-body">
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>
<div id="myModalCancel" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Warning!</h3>
  </div>
  <div class="modal-body">
    <p>Every change you may have made be will lost.</p>
    <p>Are you sure you want to continue?</p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    <a class="btn btn-primary" href="{% url 'project_detail' project.id %}">Ok</a>
  </div>
</div>
{% endifnotequal %}	
{% else %}
<p>Get out of here, you'r not authenticated!!</p>
{% endif %}
{% endblock %}