
<!DOCTYPE html>

{% load compound_tags %}
<html>
	<head>
		<title>PiMP</title>

        <meta name="author" content="Glasgow Polyomics, University of Glasgow, UK">
        <meta name="author" content="Yoann Gloaguen">
        <meta name="author" content="Fraser Morton">
        <meta name="author" content="Ross Gurden">
        <meta name="author" content="Ronan Daly">
        <meta name="author" content="Joe Wandy">
        <meta name="author" content="Simon Rogers">
        <meta name="author" content="Karl Burgess">

		<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-migrate.min.js"></script>


		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
		<link rel="shortcut icon" href="{{ STATIC_URL }}img/logo_blue_white_result.png">

		<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/base.css" media="screen"/>
		<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}bootstrap/css/bootstrap2.css" media="screen"/>
		<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}bootstrap/css/slider.css" media="screen"/>
		<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
		<link rel="stylesheet" href="{{ STATIC_URL }}css/bootstrap-image-gallery.min.css">
    	<link rel="stylesheet" href="{{ STATIC_URL }}css/jquery.fileupload-ui.css">
    	<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/dataTable/jquery.dataTables.css" media="screen" />
    	<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/dataTable/dataTables.tableTools.css" media="screen" />
    	<link rel="stylesheet" href="{{ STATIC_URL }}css/result.css">
    	<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/bootstrap-modal.css" media="screen" />
    	<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}select2-4.0.1/select2.min.css" />

		<script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-modalmanager.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}js/dataTable/jquery.dataTables1.10.4.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}js/dataTable/jquery.dataTables.columnFilter.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}js/dataTable/dataTables.tableTools.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}ColVis-1.1.2/js/dataTables.colVis.js"></script>
        <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}ColVis-1.1.2/css/dataTables.colVis.css"/>
		<script src="{{ STATIC_URL }}js/highcharts4.js"></script>
		<script src="{{ STATIC_URL }}js/highcharts-more4.js"></script>
		<script src="{{ STATIC_URL }}js/exporting4.js"></script>
		<script src="{{ STATIC_URL }}js/drilldown.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}js/dataTable/FixedHeader.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}bootstrap/js/bootstrap.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}bootstrap/js/bootstrap-slider.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}js/pimp_analysis_results_components.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}js/gp_chart.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}select2-4.0.1/select2.min.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}metExploreViz/metexploreviz.js" charset="utf-8">  </script>

		<audio id="marseillaise" src="{{ STATIC_URL }}other/marseillaise.wav" preload="auto"></audio>
    	<!-- Shim to make HTML5 elements usable in older Internet Explorer versions -->
    	<!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
		<style type="text/css">
			h1.unimg{
				position: relative;
				background: transparent;
				background-image: url({{ STATIC_URL }}img/logo_blue_white.jpg);
				background-repeat:no-repeat;
				background-size: 170px 145px;
				width: 170px;
				height: 145px;
				left: 0px;
				}
			div.gpimg{
				position: absolute;
				background: transparent;
				background-image: url({{ STATIC_URL }}img/logo_white.png);
				background-repeat:no-repeat;
				background-size: 100px 68px;
				width: 100px;
				height: 68px;
				right: 10px;
				top:50px;
				}
			#close-right-summary-panel {
				top: 10px;
				/*right: 20px;*/
				height: 16px;
				width: 16px;
				float: left;
				cursor: pointer;
				background-image: url({{ STATIC_URL }}img/plus-icon2.png);
			}

			#close-right-summary-panel:hover {
				background-image: url({{ STATIC_URL }}img/plus-icon-black.png);
			}
			.super_pathway_option {
				font-weight: bold;
			}
		</style>
		<script type="text/javascript" src="{{ STATIC_URL }}bootstrap/js/bootstrap.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}js/prefixfree.min.js"></script>
		<script type="text/javascript">
		var oTable;
		var giRedraw = false;
		var averageExport = true;
		var ppm = 3;
		var rtwindow = 120;
		var rightPanelPreference = "summary";
		var fullScreen = false;
		var right_panel = true;
		var staticUrl = "{{ STATIC_URL }}";
		var metexploreInfoUrl = "{% url 'get_metexplore_info' project.id analysis.id %}";
        var metexploreBiosourceUrl = "{% url 'get_metexplore_biosource' project.id analysis.id %}";
        var networkUrl = "{% url 'get_metexplore_network' project.id analysis.id %}";
        var metPathwayUrl = "{% url 'get_metexplore_pathways' project.id analysis.id %}";
		var metabolites_table_url = "{% url 'get_metabolites_table' project.id analysis.id %}";
		var peak_table_url = "{% url 'get_peak_table' project.id analysis.id %}";
		var averageChartType = 'column';
		var peakChromatogramsGraph = true;
        var pathwayCoverageData = null;

		function modelMatcher (params, data) {
		  data.parentText = data.parentText || "";

		  // Always return the object if there is nothing to compare
		  if ($.trim(params.term) === '') {
		    return data;
		  }

		  // Do a recursive check for options with children
		  if (data.children && data.children.length > 0) {
		    // Clone the data object if there are children
		    // This is required as we modify the object to remove any non-matches
		    var match = $.extend(true, {}, data);

		    // Check each child of the option
		    for (var c = data.children.length - 1; c >= 0; c--) {
		      var child = data.children[c];
		      child.parentText += data.parentText + " " + data.text;

		      var matches = modelMatcher(params, child);

		      // If there wasn't a match, remove the object in the array
		      if (matches == null) {
		        match.children.splice(c, 1);
		      }
		    }

		    // If any children matched, return the new object
		    if (match.children.length > 0) {
		      return match;
		    }

		    // If there were no matching children, check just the plain object
		    return modelMatcher(params, match);
		  }

		  // If the typed-in term matches the text of this term, or the text from any
		  // parent term, then it's a match.
		  var original = (data.parentText + ' ' + data.text).toUpperCase();
		  var term = params.term.toUpperCase();


		  // Check if the text contains the term
		  if (original.indexOf(term) > -1) {
		    return data;
		  }

		  // If it doesn't contain the term, don't return anything
		  return null;
		}

		var pathway_list = [
			{% for super_pathway in super_pathways_list %}{
				id: "{{ forloop.counter0 }}",
        		text: "{{ super_pathway.0 }}",
        		children: [
        			{% for pathway_name in super_pathway.1 %}{
        				id: "{{ pathway_name }}",
                		text: "{{ pathway_name }}"
        			},
        			{% endfor %}
        		]
			},
			{% endfor %}
		];

		var pathway_map = {}
		{% for super_pathway in super_pathways_list %}
		pathway_map["{{ super_pathway.0 }}"] = [{% for pathway_name in super_pathway.1 %}{id: "{{ pathway_name }}",text: "{{ pathway_name }}"},{% endfor %}];
		{% endfor %}


		// console.log(pathway_map);

		var super_pathway_list = [
			{% for super_pathway in super_pathways_list %}{
				id: "{{ super_pathway.0 }}",
        		text: "{{ super_pathway.0 }}",
			},
			{% endfor %}
		];


		// console.log(super_pathway_list)

		var comparisons = { {% for comparison in comparisons %}"{{ comparison.attributecomparison_set.all.0.attribute.name }} / {{ comparison.attributecomparison_set.all.1.attribute.name }}" : {{ comparison.id }} {% if not forloop.last %},{% endif %}{% endfor %} };
		var memberList = [{% for member in member_list %}"{{ member.name }}"{% if not forloop.last %},{% endif %}{% endfor %}];
		var memberColumnIndex = { {% for member in member_list %}"{{ member.name }}" : {{ forloop.counter0 }} {% if not forloop.last %},{% endif %}{% endfor %} };
		var sampleList = [{% for sublist in sample_list %}[{% for sample in sublist %}"{{ sample.name }}"{% if not forloop.last %},{% endif %}{% endfor %}]{% if not forloop.last %},{% endif %}{% endfor %}];

		var blankColumnIndex = memberList.length + 1;

		var marseillaise = false;

		function kegg_map_modal(map) {

				var $modal = $('#full-width');

				var chartWidth = $modal.width()-10;

				var chartHeight = $(window).height()-400;

				var modalLabel = $modal.find('#myModalLabel');
				var modalBody = $modal.find('.modal-body');

				$(modalLabel).empty();
				$(modalBody).empty();

				$(modalLabel).text("Kegg map");

				var frame = $('<iframe id="frame" src="http://www.kegg.jp/kegg-bin/show_pathway?map00473/C00022%09pink,pink/C00133%09pink,pink/C00041%09pink,pink/C00993%09pink,pink" width="'+chartWidth+'px" height="'+chartHeight+'px" style="border:none;"></iframe>');
				$(frame).appendTo($modal.find('.modal-body'));

				$modal.modal();

			}


		$(document).ready(function() {

            // $('#metexplore-li').hide();
            // $('#metexplore-viz').hide();

			// ***********************************************************************************************
			// ********************************** Sparkline plot generation **********************************
			// ***********************************************************************************************

			cell_chart();
			set_click_actions(staticUrl,metexploreInfoUrl);
			set_navbar();
			// Generate metabolites table with callback for click event

			$('#metabolites_table_super_pathway_selector').select2({
				placeholder: "Select super pathway",
				allowClear: true,
				data: super_pathway_list,
			});

			$('#metabolites_table_pathway_selector').select2({
				placeholder: "Select pathway",
				allowClear: true,
				matcher: modelMatcher,
				data: pathway_list,
			});

			var $superPathwaySelect = $("#metabolites_table_super_pathway_selector");
			var $pathwaySelect = $('#metabolites_table_pathway_selector');

			// Select a super pathway function (logic explained)
			$superPathwaySelect.on("select2:select", function (e) {
				// console.log("select2:select "+ e.target.value);
				// Change pathway select component to no option (this doesn't trigger the unselect event, has to be done separately)
				$pathwaySelect.val(null).trigger("change");
				// Trigger pathway select component "unselect" event. See below for the logic of this event
				$pathwaySelect.trigger("select2:unselect");
				// Repopulate pathway select with pathways corresponding to the superpathway selected
				var selectedSuperPathway = e.target.value;

				// Filter the metabolite data
				metabolitesTable.column(4).search('').draw();
				metabolitesTable.column(4).search(selectedSuperPathway).draw();

				$pathwaySelect.select2("destroy");
				$pathwaySelect.html('<option></option>');

				$pathwaySelect.select2({
					placeholder: "Select pathway",
  					allowClear: true,
  					matcher: modelMatcher,
  					data: pathway_map[selectedSuperPathway],
				});
				// $superPathwaySelect.select2({
				// 	placeholder: "Select super pathway",
				// 		allowClear: true,
				// 		data: super_pathway_list,
				// });
				// $superPathwaySelect.val(selectedSuperPathway).trigger("change");

			}).on("select2:unselect", function (e) {
				// When unselect super pathway, destroy and re-initialise the pathway select to initial values
				$pathwaySelect.val(null).trigger("change");
				// Trigger pathway select component "unselect" event. See below for the logic of this event
				$pathwaySelect.trigger("select2:unselect");

				$pathwaySelect.select2("destroy");
				$pathwaySelect.html('<option></option>');

				metabolitesTable.column(4).search('').draw();
				// metabolitesTable.search('').columns().search( '' ).draw();


				$pathwaySelect.select2({
					placeholder: "Select pathway",
  					allowClear: true,
  					matcher: modelMatcher,
  					data: pathway_list,
				});
			});



			$pathwaySelect.on("select2:select", function (e) {
				var selectedPathway = e.target.value;

				// Filter the metabolite data
				metabolitesTable.column(5).search(selectedPathway).draw();

			}).on("select2:unselect", function (e) {
				// console.log("pathway:unselect"+ e.target.value);
				metabolitesTable.column(5).search('').draw();

				// remove filter on datable
			});

            var samplesGroupsNum = [{{ sample_list_union|length }}, {{ comparisons|length }}, {{ sample_list|samplelistlength }}]; // [num samples, num comparisons]

			var metabolitesTable = set_metabolitestable(metabolites_table_url, samplesGroupsNum);
            $('#metabolites-table tbody').on('click', 'tr', function() {
                // When a tr is clicked, update the right panel with information about the contents of the tr

                // Row selection
                metabolitesTable.$('tr.row_selected').removeClass('row_selected'); // Remove any selected rows
                $(this).addClass('row_selected'); // Select the current row

                var data = metabolitesTable.row(this).data();

                var innerSidePanel = $(this).closest('.tab-pane').find('.right-side-bar-inner');
                updateMetabolitesRightPanel(data, innerSidePanel);
            });

            var pathwayTable = set_pathwaytable();
            //pathwayTable.$('tr').click( function () {
            pathwayTable.on('click', 'tr', function() {

                // Row selection
                pathwayTable.$('tr.row_selected').removeClass('row_selected'); // Remove any selected rows
                $(this).addClass('row_selected'); // Select the current row

                var rowInfo = pathwayTable.row(this).data();

			    var map = $(this).attr("map");

                var headers = pathwayTable.row(this).columns().header();
                var headerInfo = [];

                $.each(headers, function(idx) {
                    headerInfo.push($(headers[idx]).html());
                });

				var innerSidePanel = $(this).closest('.tab-pane').find('.right-side-bar-inner');
				updatePathwayRightPanel(rowInfo, headerInfo, innerSidePanel);

				// var kegg = $('<div class="span12" style="margin-left:0px;"><h5 class="right-side-title">Kegg map</h5></div><div class="span12" style="margin-left:0px;padding-left:13px;"><img id="kegg-map-icon" src="{{ STATIC_URL }}img/metabolic-map-icon.png" alt="tools"></div>');
                var kegg = $('<div class="span12" style="padding-bottom:14px;"><div class="card-face-footer"><span class="card-face__social" id="kegg-map-icon"><img src="{{ STATIC_URL }}img/pathway_icon.svg" width="36" height="36" draggable="false"></span></div>')

				pathwayCoverageData = calculPathwayCoverage(rowInfo, headerInfo);
				// var chartWidth = $(innerSidePanel).find('.span12').width()-10;
				// var chart1 = $('<div class="span12" style="margin-left:0px;">');
                var chartWidth = $('#card-content-pathway-coverage').width()-10;
                var chart1 = $('#card-content-pathway-coverage');
				// pieChart(chartWidth, chart1, data, 400);
				// $(kegg).appendTo($(innerSidePanel));
                $(kegg).appendTo($('#kegg-btn-div'));
				// $(chart1).appendTo($(innerSidePanel));

				$('#kegg-map-icon').click(function() {
					var $modal = $('#full-width');

					var chartWidth = $modal.width()-10;

					var chartHeight = $(window).height()-200;

					var modalLabel = $modal.find('#myModalLabel');
					var modalBody = $modal.find('.modal-body');

					$(modalLabel).empty();
					$(modalBody).empty();

					$(modalLabel).text("Kegg map");

					var pathwaySelection = '<div class="span3"><label for="comparison_index" style="font-weight:bold;margin-right:12px;">Map comparison</label><select name="comparison_index_mapping" class="comparison_index" style="width:140px" id="comparison_index"><option value="None">None</option>';

					$.each(comparisons, function( index, value ){
						pathwaySelection += '<option value="'+ value +'">'+ index +'</option>';
					});
					pathwaySelection += '</select></div><div class="span2" style="padding-top: 24px;"><img src="{{ STATIC_URL }}img/identified_kegg_dot.png" alt="id_kegg" style="height:10px;"><span style="margin-left: 10px;font-size: 12px;">Identified</span></div><div class="span2" style="padding-top: 24px;"><img src="{{ STATIC_URL }}img/annotated_kegg_dot.png" alt="anot_kegg" style="height:10px;"><span style="margin-left: 10px;font-size: 12px;">Annotated</span></div><div class="span2" style="padding-top: 24px;"><img src="{{ STATIC_URL }}img/up_down_kegg.png" alt="anot_kegg" style="height:10px;"><span style="margin-left: 10px;font-size: 12px;">Up/Down</span></div><div class="span3" style="padding-top: 16px;"><div class="row" style="margin-left:0px; margin-bottom:0px;"><div style="height: 20px;width: 110px;" class="gradient_legend" id="drapeau_francais"></div></div><div class="row" style="margin-left:0px; margin-bottom:0px;"><div style="height: 20px;width: 110px;"><span style="font-size: 12px;float: left;">-2</span><span style="font-size: 12px;float: left;margin-left: 41px;">0</span><span style="font-size: 12px;float: right;">2</span></div></div></div>';

					var ajax_data = {"id": rowInfo[1]};

					var url = "{% url 'get_pathway_url' project.id analysis.id %}";

					$.ajax({
						type: "GET",
						traditional : true,
			            url: url,
			            data: ajax_data,
			            success: function(response) {
			            	// console.log(response["pathway_map"]);
			            	var frame = $('<iframe id="frame" src="'+response["pathway_map"]+'" width="'+chartWidth+'px" height="'+chartHeight+'px" style="border:none;"></iframe>');

							$(pathwaySelection).appendTo($modal.find('.modal-body'));
							$(frame).appendTo($modal.find('.modal-body'));

							$modal.modal();

							$('#drapeau_francais').click( function(){
								if (marseillaise) {
									marseillaise = false;
									document.getElementById('marseillaise').pause();
								}
								else {
									marseillaise = true;
									document.getElementById('marseillaise').play();
									document.getElementById('marseillaise').onended = function() {
										marseillaise = false;
									}
								}
							});

							$('#comparison_index').change(function () {
				        		// console.log("comparison just changed!!");
				        		var comparison_map = this.value;
				        		var ajax_data = {"id":rowInfo[1], "comparison":comparison_map};
				        		var frame = $modal.find('iframe');
				        		$.ajax({
									type: "GET",
									traditional : true,
						            url: url,
						            data: ajax_data,
						            success: function(response){
						            	var new_frame = $('<iframe id="frame" src="'+response["pathway_map"]+'" width="'+chartWidth+'px" height="'+chartHeight+'px" style="border:none;"></iframe>');
				        				$(frame).remove();
				        				$(new_frame).appendTo($modal.find('.modal-body'));
				        			},
						            error: function(){
						        		alert("Error");
						        	}
				        		});
			        		});
			            },
			            error: function(){
			        		alert("Error");
			        	}
			        });

				});

			});

            var peakTable = set_peaktable(peak_table_url);
            $('#peak-table tbody').on('click', 'tr', function() {
                // Row selection
                peakTable.$('tr.row_selected').removeClass('row_selected'); // Remove any selected rows
                $(this).addClass('row_selected'); // Select the current row

                var averageChart = false;
				var peaksChart = false;
			    var data = peakTable.row(this).data();

                var headers = peakTable.row(this).columns([0, 1, 2, data.length - 1]).header();
                var headerInfoToPass = [];

                $.each(headers, function(idx) {
                    headerInfoToPass.push($(headers[idx]).html());
                })

                var rowInfo = [data[0], data[1], data[2], data[data.length - 1]];

                var innerSidePanel = $(this).closest('.tab-pane').find('.right-side-bar-inner');
                updatePeakRightPanel(rowInfo,headerInfoToPass,innerSidePanel);

                // The following code is commented as the card system is now in place for the peak tab, needs to be deleted

    //             var loadingPan = $('<div class="span12" style="margin-left:0px;cursor:progress;"><img src="{{ STATIC_URL }}img/Poly-logo_speed4.gif" alt="loading" style="text-align:center;margin:auto;"><p style="text-align:center;">Loading peaks...</p></div>');
				// $(loadingPan).appendTo($(innerSidePanel));
				// var ajax_data = {"id":rowInfo[0]};

				// var url = "{% url 'get_peak_info_peak_id' project.id analysis.id %}";

				// $.ajax({
				// 	type: "GET",
				// 	traditional : true,
		  //           url: url,
		  //           // async: false,
		  //           data: ajax_data,
		  //           success: function(response){
		  //           	chartWidth = $(innerSidePanel).find('.span12').width()-10;
				// 		var averageIntensityChart = $('<div class="span12" style="margin-left:0px;"></div>');

				// 		averageIntensityChartFromCompound(chartWidth, averageIntensityChart, response);
				// 		$(loadingPan).before($(averageIntensityChart));

				// 		averageChart = true;
				// 		if (averageChart && peaksChart){
				// 			$(loadingPan).remove();
				// 		}
		  //           },
		  //           error: function(){
		  //       		alert("Error");
		  //       	}
		  //       });
				// Debug uncomment from here
		  //       var data = {"id":rowInfo[0],"ppm":ppm,"rtwindow":rtwindow};

				// var url = "{% url 'get_peaks_from_peak_id' project.id analysis.id %}";

				// $.ajax({
				// 	type: "GET",
				// 	traditional : true,
		  //           url: url,
		  //           // async: false,
		  //           data: data,
		  //           success: function(response){
		  //           	chartWidth = $(innerSidePanel).find('.span12').width()-10;
				// 		var peakChart = $('<div class="span12" style="margin-left:0px;"></div>');

				// 		createPeaksChromatogram(chartWidth, peakChart, response);

				// 		$(loadingPan).before($(peakChart));

				// 		peaksChart = true;
				// 		if (averageChart && peaksChart){
				// 			$(loadingPan).remove();
				// 		}
		  //           },
		  //           error: function(){
		  //       		alert("Error");
		  //       	}
		  //       });
				// Debug uncomment to here
			});

			var comparisonTable = set_comparisontable();

			// ***********************************************************************************************
			// ******************************** End sparkline plot generation ********************************
			// ***********************************************************************************************

			$('#home-side-nav').affix();

			// PCA CHART CREATION
			$('#pca_test').highcharts({
				credits : {
						enabled : false
				},
	            chart: {
	                type: 'scatter',
	                zoomType: 'xy',
	                height: 500,
	                width: 500,
	            },
	            title: {
	                text: 'PCA'
	            },
	            subtitle: {
	                text: 'Click and drag in the plot area to zoom in'
	            },
	            xAxis: {
	                title: {
	                    enabled: true,
	                    text: 'PC 1 ({{explained_variance.0|floatformat}}%)'
	                },
	                startOnTick: true,
	                endOnTick: true,
	                showLastLabel: true
	            },
	            yAxis: {
	                title: {
	                    text: 'PC 2 ({{explained_variance.1|floatformat}}%)'
	                }
	            },
	            legend: {
	                backgroundColor: '#FFFFFF',
	                borderWidth: 1
	            },
	            plotOptions: {
	                scatter: {
	                    marker: {
							symbol: 'circle',
	                        radius: 4,
	                        states: {
	                            hover: {
	                                enabled: true,
	                                lineColor: 'rgb(100,100,100)'
	                            }
	                        }
	                    },
	                    states: {
	                        hover: {
	                            marker: {
	                                enabled: false
	                            }
	                        }
	                    },
	                    tooltip: {
	                        headerFormat: '<b>{series.name}</b><br>',
	                        pointFormat: '{point.name}<br>pc1: {point.x:.1f}<br>pc2: {point.y:.1f}'
	                    }
	                }
	            },
	            series: [{% for serie in pca_data_point.2 %}{
	                name: '{{ serie.0 }}',
	                data: [{% for point in serie %}
		                		{% if not forloop.first %}
		                			{
		                				name: '{{ point.0 }}',
		                				x: {{ point.1 }},
		                				y: {{ point.2 }}
		                			}{% if not forloop.last %},{% endif %}
		                		{% endif %}
		                	{% endfor %}
		                	]
		                }{% if not forloop.last %},{% endif %}
		                {% endfor %}
		                ]
        	});


			{% for group, sample_dict in tics.items %}
			$('#tic_pos{{group.id}}').highcharts({
				credits: {
					enabled: false,
				},
				title: {
					text: "{{group.name| capfirst}} (POS)"
				},
				chart: {
					backgroundColor: "#ffffff",
					zoomType: 'x',
				},
				exporting: {
	            	enabled: true,
	            	filename: "{{group.name | capfirst}}" + "_positive_TIC",
			    },
				xAxis: {
					title: {
						text: "Retention time (s)",
					},
				},
				yAxis: {
					title: {
						text: "Abundance",
					},
					min: 0,
				},
				plotOptions: {
					area : {
						marker: {
							enabled: false,
						},
					},
					series: {
        				fillOpacity: 0.1,
        			},
				},
				series: [
					{% for sample,pos_neg in sample_dict.items %}
					{
						type: 'area',
						name: '{{sample}}',
						data: {{pos_neg.pos}},
					},
					{% endfor %}
					]
			});
			{% endfor %}



			{% for group, sample_dict in tics.items %}
			$('#tic_neg{{group.id}}').highcharts({
				credits: {
					enabled: false,
				},
				title: {
					text: "{{group.name | capfirst}} (NEG)"
				},
				chart: {
					backgroundColor: "#ffffff",
					zoomType: 'x',
				},
				exporting: {
			            	enabled: true,
			            	filename: "{{group.name | capfirst}}" + "_negative_TIC",
			    },
				xAxis: {
					title:
					{
						text: "Retention time (s)",
					},
				},
				yAxis: {
					title:
					{
						text: "Abundance",
					},
					min: 0,
				},
				plotOptions: {
					area : {
						marker: {
							enabled: false,
						},
					},
					series: {
        				fillOpacity: 0.1,
        			},
				},
				series: [
					{% for sample,pos_neg in sample_dict.items %}
					{
						type: 'area',
						name: '{{sample}}',
						data: {{pos_neg.neg}},
					},
					{% endfor %}
					]
			});
			{% endfor %}


			{% for comparison in comparison_info %}
			$('#comparison{{ comparison.0.id }}-volcano-plot').highcharts({
				credits : {
						enabled : false
				},
	            chart: {
	                type: 'scatter',
	                zoomType: 'xy',
	                height: 500,
	                width: 500,
	            },
	            title: {
	                text: '{{ comparison.0.attributecomparison_set.all.0.attribute.name }} / {{ comparison.0.attributecomparison_set.all.1.attribute.name }} volcano plot'
	            },
	            subtitle: {
	                text: 'Click and drag in the plot area to zoom in'
	            },
	            xAxis: {
	                title: {
	                    enabled: true,
	                    text: 'log2 Fold Change'
	                },
	                startOnTick: true,
	                endOnTick: true,
	                showLastLabel: true
	            },
	            yAxis: {
	                title: {
	                    text: '-log10 adjusted P-Value'
	                }
	            },
	            legend: {
	                backgroundColor: '#FFFFFF',
	                borderWidth: 1
	            },
	            plotOptions: {
	                scatter: {
	                	turboThreshold: 0,
	                    marker: {
            				symbol: 'circle',
	                        radius: 4,
	                        states: {
	                            hover: {
	                                enabled: true,
	                                lineColor: 'rgb(100,100,100)'
	                            }
	                        }
	                    },
	                    states: {
	                        hover: {
	                            marker: {
	                                enabled: false
	                            }
	                        }
	                    },
	                    tooltip: {
	                        headerFormat: '<b>{series.name}</b><br>',
	                        pointFormat: '{point.name}<br>Log2 Fold Change: {point.x:.1f}<br>-log10 P-value: {point.y:.1f}'
	                    }
	                },
	                series: {
		                cursor: 'pointer',
		                point: {
		                    events: {
		                        click: function () {
		                            // alert('id: ' + this.id + ', value: ' + this.y + ', name ' + this.name);
		                            var ajax_data = {"id":this.name.split(" ")[1]};
									popup_window_compound_list(ajax_data);
		                        }
		                    }
		                }
		            }
	            },
	            series: [{
					{% with comparison|timer_start as time %}
	                name: 'Adj. P-value > 0.05',
	                data: [{% for peak in comparison.1 %}
{#		                		{% with peak.peakdtcomparison_set.all|comparisoninfo:comparison.id as compinfo %} #}
		                			{% if peak.2 > 0.05 %}
		                			{
		                				name: 'Peak {{ peak.0 }}',
		                				x: {{ peak.1  }},
		                				y: {{ peak.2|minuslogten }},
		                			}{% if not forloop.last %},{% endif %}
		                			{% endif %}
{#		                		{% endwith %} #}
		                	{% endfor %}
//					{{ time|timer_end:'Non-significant peaks' }}
					{% endwith %}
		                	]
		            },
		            {
					{% with comparison|timer_start as time %}
	                name: 'Adj. P-value &lt; 0.05',
	                data: [{% for peak in comparison.1 %}
{#		                		{% with peak.peakdtcomparison_set.all|comparisoninfo:comparison.id as compinfo %} #}
		                			{% if peak.2 < 0.05 %}
		                			{
		                				name: 'Peak {{ peak.0 }}',
		                				x: {{ peak.1  }},
		                				y: {{ peak.2|minuslogten }},
		                			}{% if not forloop.last %},{% endif %}
		                			{% endif %}
{#		                		{% endwith %} #}
		                	{% endfor %}
//					{{ time|timer_end:'Significant peaks' }}
					{% endwith %}
		                	]
		            },
            	]
        	});
			{% endfor %}


			$(".peak_id").click( function() {

				var ajax_data = {"id":$(this).html()};
				popup_window_compound_list(ajax_data);
			});

			function popup_window_compound_list(ajax_data){

				var url = "{% url 'get_compounds_from_peak_id' project.id analysis.id %}";

				var $modal = $("#small-window");
				var modalBody = $modal.find('.modal-body');
				var modalHeader = $modal.find('.modal-header');
				var modalFooter = $modal.find('.modal-footer');

				// Empty modal window

				$(modalBody).empty();
				// $(modalFooter).empty();
				$(modalHeader).empty();

		        $.ajax({
					type: "GET",
					traditional : true,
		            url: url,
		            data: ajax_data,
		            success: function(response){
		            	//console.log(response);
		            	if (response.length > 1){
		            		var pluralize_compound = "compounds";
		            	}
		            	else {
		            		var pluralize_compound = "compound";
		            	}
		            	$('<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button><h3 id="myModalLabel">Peak ' + ajax_data["id"] + ': ' + response.length + ' putative ' + pluralize_compound + '</h3>').appendTo($(modalHeader));
		            	var newDom = '';
		            	var compound_count = null;

		            	for (var i=0;i<response.length;i++){
		            		compound_count = i+1;
		            		if (response[i].length > 1){
		            			if (i%2 == 1){
		            				newDom += '<div class="grey_compound_name" style="margin-bottom: 10px;margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;"><span style="margin-right:15px;">' + compound_count + '</span><span>'+response[i][0]+'</span><span style="float: right;"><img id="compound_toggle_down_button-' + i + '" class="compound_toggle_down" src="{{ STATIC_URL }}img/toggle_down_arrow.png" style="height: 15px;margin-right: 20px;padding-bottom: 4px;"></span></div>';
		            			}
		            			else{
		            				newDom += '<div class="red-compound-name-list" style="margin-bottom: 10px;margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;"><span style="margin-right:15px;">' + compound_count + '</span><span>'+response[i][0]+'</span><span style="float: right;"><img id="compound_toggle_down_button-' + i + '" class="compound_toggle_down" src="{{ STATIC_URL }}img/toggle_down_arrow.png" style="height: 15px;margin-right: 20px;padding-bottom: 4px;"></span></div>';
		            			}
		            			for (var j=1; j<response[i].length; j++){
		            				newDom += '<div class="compound_alias compound_alias_class_' + i + '" style="margin-left:0px;padding-left:13px;background-color: #EBF6FF"><p style="padding-left:10px;padding-top: 8px;padding-bottom: 8px;">alias: '+response[i][j]+'</p></div>';
		            			}
		            		}
		            		else {
		            			if (i%2 == 1){
		            				newDom += '<div class="grey_compound_name" style="margin-bottom: 10px;margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;"><span style="margin-right:15px;">' + compound_count + '</span><span>'+response[i][0]+'</span></div>';
		            			}
		            			else{
		            				newDom += '<div class="red-compound-name-list" style="margin-bottom: 10px;margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;"><span style="margin-right:15px;">' + compound_count + '</span><span>'+response[i][0]+'</span></div>';
		            			}
		            		}
		            	}

		            	// var scrollBox = $('<div class="span12" style="overflow: auto;margin-left:0px;max-height:300px;background-color:white;border-left: 1px solid whitesmoke;margin-bottom: 30px;" ></div>');
		            	// $(compoundTitle).appendTo($(innerSidePanel));
		            	// $(newDom).appendTo($(scrollBox));
		            	// $(scrollBox).appendTo($(innerSidePanel));
		            	$(newDom).appendTo($(modalBody));
		            	$(modalBody).css("max-height","400px");
		            	$(modalBody).css("overflow","auto");

		            	$('.compound_toggle_down').click( function(){
		            		if ($(this).hasClass("active")){
		            			var compound_id_clicked = ".compound_alias_class_" + $(this).attr("id").split("-")[1];
			            		$(this).removeClass("active");
			            		$(compound_id_clicked).removeClass("active");
		            		}
		            		else {
			            		var compound_id_clicked = ".compound_alias_class_" + $(this).attr("id").split("-")[1];
			            		$(this).addClass("active");
			            		$(compound_id_clicked).addClass("active");
		            		}
		            	});

		            	$modal.modal();

		            },
		            error: function(){
		        		alert("Error");
		        	}
		        });

			}

			comparisonTable.$('tr').click( function () {
				// get data from the row clicked as an array
			    var data = comparisonTable.fnGetData( this );

			    // remove any row selection from the table
			    $(comparisonTable.fnSettings().aoData).each(function (){
					$(this.nTr).removeClass('row_selected');
				});

				// set the clicked row as selected
				var selectedRow = $(event.target.parentNode).addClass('row_selected');

				// extract header information in an array
				var headerInfo = new Array();
				$.each(comparisonTable.dataTableSettings[3].aoColumns, function(i,v) {
					headerInfo.push(v.sTitle);
				});

				// get the right side panel div that has to be updated
				var innerSidePanel = $(this).closest('.tab-pane').find('.right-side-bar-inner');

				rowInfo = data;
				headerInfoToPass = headerInfo;

				// send info to update right panel
				updateRightPanel(rowInfo,headerInfoToPass,innerSidePanel);
				var loadingPan = $('<div class="span12" style="margin-left:0px;cursor:progress;"><img src="{{ STATIC_URL }}img/Poly-logo_speed4.gif" alt="loading" style="text-align:center;margin:auto;"><p style="text-align:center;">Loading peaks...</p></div>');
				$(loadingPan).appendTo($(innerSidePanel));
				var ajax_data = {"id":rowInfo[0]};

				var url = "{% url 'get_peak_info_peak_id' project.id analysis.id %}";

				$.ajax({
					type: "GET",
					traditional : true,
		            url: url,
		            data: ajax_data,
		            success: function(response){
		            	chartWidth = $(innerSidePanel).find('.span12').width()-10;
						var averageIntensityChart = $('<div class="span12" style="margin-left:0px;"></div>');

						averageIntensityChartFromCompound(chartWidth, averageIntensityChart, response);
						$(loadingPan).before($(averageIntensityChart));
						$(loadingPan).remove();
		            },
		            error: function(){
		        		alert("Error");
		        	}
		        });

		        var url = "{% url 'get_compounds_from_peak_id' project.id analysis.id %}";

		        $.ajax({
					type: "GET",
					traditional : true,
		            url: url,
		            data: ajax_data,
		            success: function(response){
		            	var compoundTitle = $('<div class="span12" style="margin-left:0px;"><h5 class="right-side-title">Compounds</h5></div>');
		            	var newDom = '';

		            	for (var i=0;i<response.length;i++){
		            		if (response[i].length > 1){
		            			if (i%2 == 1){
		            				newDom += '<div class="span12" style="margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;"><p>'+response[i][0]+'</p></div>';
		            			}
		            			else{
		            				newDom += '<div class="span12 red-compound-name-list" style="margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;"><p>'+response[i][0]+'</p></div>';
		            			}
		            			for (var j=1; j<response[i].length; j++){
		            				newDom += '<div class="span12" style="margin-left:0px;padding-left:13px;background-color: #EBF6FF"><p style="padding-left:10px;padding-top: 8px;">alias: '+response[i][j]+'</p></div>';
		            			}
		            		}
		            		else {
		            			if (i%2 == 1){
		            				newDom += '<div class="span12" style="margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;"><p>'+response[i][0]+'</p></div>';
		            			}
		            			else{
		            				newDom += '<div class="span12 red-compound-name-list" style="margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;"><p>'+response[i][0]+'</p></div>';
		            			}
		            		}
		            	}
		            	var scrollBox = $('<div class="span12" style="overflow: auto;margin-left:0px;max-height:300px;background-color:white;border-left: 1px solid whitesmoke;margin-bottom: 30px;" ></div>');
		            	$(compoundTitle).appendTo($(innerSidePanel));
		            	$(newDom).appendTo($(scrollBox));
		            	$(scrollBox).appendTo($(innerSidePanel));

		            },
		            error: function(){
		        		alert("Error");
		        	}
		        });
		    });

			{% for comparison in comparisons %}
				var comparisonTable{{ comparison.id }} = $('#comparison{{ comparison.id }}-table').dataTable( {
                    "sAjaxSource": "{% url 'get_single_comparison_table' project.id analysis.id comparison.id %}",
                    "aoColumnDefs": [{
                            "aTargets": [1],
                            "sType": "formatted-lfc",
                            "mRender": function(lfc, type, full) {
                                var value = Number((lfc).toFixed(2))
                                // var value = Math.floor(rt / 60);
                                // var seconds = Math.round(rt % 60); // Rounded to nearest second
                                // return rt + " ("+ minutes + " min "+ seconds + " s)";
                                return value
                            }
                        },
                        {
                            "aTargets": [2],
                            "sType": "formatted-pv",
                            "mRender": function(pv, type, full) {
                                var value = Number((pv).toFixed(4))
                                // var value = Math.floor(rt / 60);
                                // var seconds = Math.round(rt % 60); // Rounded to nearest second
                                // return rt + " ("+ minutes + " min "+ seconds + " s)";
                                return value
                            }
                        },
                        {
                            "aTargets": [3],
                            "sType": "formatted-lfc",
                            "mRender": function(apv, type, full) {
                                var value = Number((apv).toFixed(4))
                                // var value = Math.floor(rt / 60);
                                // var seconds = Math.round(rt % 60); // Rounded to nearest second
                                // return rt + " ("+ minutes + " min "+ seconds + " s)";
                                return value
                            }
                        },
                        {
                            "aTargets": [4],
                            "sType": "formatted-lfc",
                            "mRender": function(lo, type, full) {
                                var value = Number((lo).toFixed(4))
                                // var value = Math.floor(rt / 60);
                                // var seconds = Math.round(rt % 60); // Rounded to nearest second
                                // return rt + " ("+ minutes + " min "+ seconds + " s)";
                                return value
                            }
                        }],
					"sDom": '<"comparison-table_wrapper_toolbar"liT>rtp',
					"tableTools": {
			            "sSwfPath": "/static/swf/copy_csv_xls.swf",
			            "aButtons": [
			                {
                    			"sExtends": "copy",
                    			"sButtonText": "Copy",
                    			"mColumns": "visible",
                    			"sToolTip": "Copy to clipboard"
                			},
			                {
			                    "sExtends":    "collection",
			                    "sButtonText": "Export",
			                    "aButtons":    [
			                    	{
					                    "sExtends": "csv",
					                    "sButtonText": "csv",
					                    "mColumns": "visible",
					                    "sFileName": "single_comparison.csv",
					                    "sToolTip": "Save as CSV"
                					},
                					{
                    					"sExtends": "xls",
                    					"sButtonText": "xls",
                    					"mColumns": "visible",
                    					"sFileName": "single_comparison.xls",
                    					"sToolTip": "Save as XLS"
                					}
                				]
			                }
			            ]
			        },
					"bPaginate": true,
					"sPaginationType": "full_numbers",
					"iDisplayLength": 100,
					"aLengthMenu": [ 100, 250, 500, 1000 ],
			}).columnFilter({ 	sPlaceHolder: "head:after",
								sRangeFormat: "Min {from} Max {to}",
					aoColumns: [ 	{ type: "text" },
				    	 			{ type: "number-range" },
                                    { type: "number-range" },
                                    { type: "number-range" },
                                    { type: "number-range" }
						]

			});
			{% endfor %}

			{% for comparison in comparisons %}
            $('#comparison{{ comparison.id }}-table').on('click', 'tr', function() {
			// comparisonTable{{ comparison.id }}.$('tr').click( function () {
				// get data from the row clicked as an array
			    var data = comparisonTable{{ comparison.id }}.fnGetData( this );

			    // remove any row selection from the table
			    $(comparisonTable{{ comparison.id }}.fnSettings().aoData).each(function (){
					$(this.nTr).removeClass('row_selected');
				});

				// set the clicked row as selected
				var selectedRow = $(event.target.parentNode).addClass('row_selected');

				// extract header information in an array
				var headerInfo = new Array();
				$.each(comparisonTable{{ comparison.id }}.dataTableSettings[{{ forloop.counter0 }}+4].aoColumns, function(i,v) {
					headerInfo.push(v.sTitle);
				});

				// get the right side panel div that has to be updated
				var innerSidePanel = $(this).closest('.tab-pane').find('.right-side-bar-inner');

				rowInfo = data;
				headerInfoToPass = headerInfo;

				// send info to update right panel
				updateRightPanel(rowInfo,headerInfoToPass,innerSidePanel);
				var loadingPan = $('<div class="span12" style="margin-left:0px;cursor:progress;"><img src="{{ STATIC_URL }}img/Poly-logo_speed4.gif" alt="loading" style="text-align:center;margin:auto;"><p style="text-align:center;">Loading peaks...</p></div>');
				$(loadingPan).appendTo($(innerSidePanel));
				var ajax_data = {"id":rowInfo[0],"comparison":{{ comparison.id }} };

				var url = "{% url 'get_peak_info_peak_id' project.id analysis.id %}";

				$.ajax({
					type: "GET",
					traditional : true,
		            url: url,
		            data: ajax_data,
		            success: function(response){
		            	chartWidth = $(innerSidePanel).find('.span12').width()-10;
						var averageIntensityChart = $('<div class="span12" style="margin-left:0px;"></div>');

						averageIntensityChartFromCompound(chartWidth, averageIntensityChart, response);
						$(loadingPan).before($(averageIntensityChart));
						$(loadingPan).remove();
		            },
		            error: function(){
		        		alert("Error");
		        	}
		        });

		        var url = "{% url 'get_compounds_from_peak_id' project.id analysis.id %}";

		        $.ajax({
					type: "GET",
					traditional : true,
		            url: url,
		            // async: false,
		            data: ajax_data,
		            success: function(response){
		            	var compoundTitle = $('<div class="span12" style="margin-left:0px;"><h5 class="right-side-title">Compounds</h5></div>');
		            	var newDom = '';

		            	for (var i=0;i<response.length;i++){
		            		if (response[i].length > 1){
		            			if (i%2 == 1){
		            				newDom += '<div class="span12" style="margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;border-top: 2px solid #ACACAC;"><p>'+response[i][0]+'</p></div>';
		            			}
		            			else{
		            				newDom += '<div class="span12 red-compound-name-list" style="margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;border-top: 2px solid #ACACAC;"><p>'+response[i][0]+'</p></div>';
		            			}
		            			for (var j=1; j<response[i].length; j++){
		            				newDom += '<div class="span12" style="margin-left:0px;padding-left:13px;background-color: #EBF6FF"><p style="padding-left:10px;padding-top: 8px;">alias: '+response[i][j]+'</p></div>';
		            			}
		            		}
		            		else {
		            			if (i%2 == 1){
		            				newDom += '<div class="span12" style="margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;border-top: 2px solid #ACACAC;"><p>'+response[i][0]+'</p></div>';
		            			}
		            			else{
		            				newDom += '<div class="span12 red-compound-name-list" style="margin-left:0px;padding-left:13px;min-height:27px;padding-top: 8px;border-top: 2px solid #ACACAC;"><p>'+response[i][0]+'</p></div>';
		            			}
		            		}
		            	}
		            	var scrollBox = $('<div class="span12" style="overflow: auto;margin-left:0px;max-height:300px;background-color:white;border-left: 1px solid whitesmoke;margin-bottom: 30px;" ></div>');
		            	$(compoundTitle).appendTo($(innerSidePanel));
		            	$(newDom).appendTo($(scrollBox));
		            	$(scrollBox).appendTo($(innerSidePanel));

		            },
		            error: function(){
		        		alert("Error");
		        	}
		        });
		    });
			{% endfor %}


			// Add search handler for search on metabolitesTable only
			$("#search").keyup( function () {
			// Filter on the column (the index) of this element
				// metabolitesTable.fnFilterAll(this.value);
				$("#search2-input").val(String(this.value));
				metabolitesTable.search(this.value).draw();
				pathwayTable.fnFilter(this.value);
				peakTable.fnFilter(this.value);
				comparisonTable.fnFilter(this.value);
				{% for comparison in comparisons %}
				comparisonTable{{ comparison.id }}.fnFilter(this.value);
				{% endfor %}
			});

			$("#search2-input").keyup( function () {
			// Filter on the column (the index) of this element
				$("#search").val(String(this.value));
				metabolitesTable.search(this.value).draw();
				pathwayTable.fnFilter(this.value);
				peakTable.fnFilter(this.value);
				comparisonTable.fnFilter(this.value);
				{% for comparison in comparisons %}
				comparisonTable{{ comparison.id }}.fnFilter(this.value);
				{% endfor %}
			});

			function calculPathwayCoverage(data,names){
				var annotated = parseInt(data[3])*100/parseInt(data[2]);
				var identified = parseInt(data[4])*100/parseInt(data[2]);
				var notcoveredNumber = parseInt(data[2])-(parseInt(data[3])+parseInt(data[4]));
				var notcovered = notcoveredNumber*100/parseInt(data[2]);
				var serie = [['Annotated',annotated],['Not covered',notcovered],['Identified',identified]];
				return serie;
			}

			function pieChart(chartWidth, div, data, height){
				$(div).highcharts({
					credits : {
						enabled : false
					},
		            chart: {
		            	width: chartWidth,
		            	height: height,
		            	backgroundColor: '#FFFFFF',
		                plotBackgroundColor: null,
		                plotBorderWidth: null,
		                plotShadow: false
		            },
		            title: {
		                text: 'Map coverage'
		            },
		            tooltip: {
		        	    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
		            },
		            plotOptions: {
		                pie: {
		                    allowPointSelect: true,
		                    cursor: 'pointer',
		                    dataLabels: {
		                        enabled: false
		                    },
		                    showInLegend: true
		                }
		            },
		            series: [{
		                type: 'pie',
		                name: 'Pathway coverage',
		                data: data
		            }]
		        });
			}

            // Functions for the chromatogram and intensity plot buttons in the metabolites side bar
            $('.right-side-bar-inner')
                    .on('click', '.metabolites-chromatogram-btn', function(e) {
                    // Creates the chromatogram, which is used to replace the associated button

                    // Override the event to stop any action e.g. form submission
                    e.preventDefault();

                    // Get the associated peak secondaryID
                    var peakID = $(this).prop('id').split("-")[1];

                    // Get the correct div to insert the chromatogram
                    // var chromatogramDiv = $(this).closest('.metabolites-chromatogram-div');
                    var cardPlotDiv = $('#card-content-peak-'+peakID);

                    var intensityPlotDiv = $('#card-intensity-'+peakID);

                    var chromatogramPlotDiv = $('#card-chromatogram-'+peakID);

                    // Remove the button and replace with a loading image
                    // $(this).remove();

                    if (chromatogramPlotDiv.attr('data-exist') == 'true'){
                        if (cardPlotDiv.attr('content-displayed') == 'chromatogram'){
                            cardPlotDiv.toggle('slow');
                        }
                        else {
                            intensityPlotDiv.hide();
                            chromatogramPlotDiv.show();
                            cardPlotDiv.attr('content-displayed','chromatogram');
                            if (cardPlotDiv.css('display') == 'none'){
                                cardPlotDiv.toggle('slow');
                            }
                        }
                    }
                    else {
                        var loadingPan = $('<div class="span12" style="margin-left: 0px; margin-top: 20px; cursor: progress;display:none;"><img src="{{ STATIC_URL }}img/Poly-logo_speed4.gif" alt="loading" style="text-align: center; margin: auto;"><p style="text-align: center;">Loading chromatogram...</p></div>');
                        $(loadingPan).appendTo(cardPlotDiv);
                        cardPlotDiv.show();
                        if (cardPlotDiv.attr('content-displayed') == 'none'){
                            loadingPan.toggle('slow');
                        }
                        else{
                            intensityPlotDiv.hide();
                            loadingPan.show();
                        }
                        
                        // Make the AJAX call for the chromatogram
                        var data = {"id": peakID, "ppm": ppm, "rtwindow": rtwindow};
                        var url = "{% url 'get_peaks_from_peak_id' project.id analysis.id %}";

                        $.ajax({
                            type: "GET",
                            traditional : true,
                            url: url,
                            data: data,
                            success: function(response){
                                // Empty the chromatogramDiv
                                // chromatogramDiv.empty();

                                // And fill the div with the chromatogram
                                var chartWidth = $(cardPlotDiv).width() - 10;

                                createPeaksChromatogram(chartWidth, chromatogramPlotDiv, response);

                                chromatogramPlotDiv.attr('data-exist', 'true');

                                // Remove the loading graphic
                                loadingPan.remove();
                                // if (intensityPlotDiv.css('display') == 'none'){
                                if (cardPlotDiv.attr('content-displayed') == 'none'){
                                    // chromatogramPlotDiv.show();
                                    chromatogramPlotDiv.toggle('slow');
                                    console.log("data doesn't exist and content-displayed == none");
                                    cardPlotDiv.attr('content-displayed','chromatogram');
                                    // cardPlotDiv.toggle('slow');
                                }
                                else {
                                    // intensityPlotDiv.hide();
                                    chromatogramPlotDiv.show();
                                    cardPlotDiv.attr('content-displayed','chromatogram');
                                    console.log("content display == "+cardPlotDiv.attr('content-displayed'));
                                    if (cardPlotDiv.css('display') == 'none'){
                                        cardPlotDiv.toggle('slow');
                                    }
                                }
                            },
                            error: function(){
                                alert("Error with chromatogram in metabolites tab");
                            }
                        });
                    }
                })
                .on('click', '.metabolites-intensity-plot-btn', function(e) {
                    // Override the event to stop any action e.g. form submission
                    e.preventDefault();

                    // Get the associated peak secondaryID
                    var peakID = $(this).prop('id').split("-")[1];

                    // Get the correct div to insert the intensity plot
                    // var intensityPlotDiv = $(this).closest('.card-content');
                    var cardPlotDiv = $('#card-content-peak-'+peakID);

                    var intensityPlotDiv = $('#card-intensity-'+peakID);

                    var chromatogramPlotDiv = $('#card-chromatogram-'+peakID);

                    // Remove the button and replace with a loading image
                    // $(this).remove();

                    if (intensityPlotDiv.attr('data-exist') == 'true'){
                        if (cardPlotDiv.attr('content-displayed') == 'intensity'){
                            cardPlotDiv.toggle('slow');
                        }
                        else {
                            chromatogramPlotDiv.hide();
                            intensityPlotDiv.show();
                            cardPlotDiv.attr('content-displayed','intensity');
                            if (cardPlotDiv.css('display') == 'none'){
                                cardPlotDiv.toggle('slow');
                            }
                        }
                    }
                    else {
                        var loadingPan = $('<div class="span12" style="margin-left: 0px; margin-top: 20px; cursor: progress;"><img src="{{ STATIC_URL }}img/Poly-logo_speed4.gif" alt="loading" style="text-align: center; margin: auto;"><p style="text-align: center;">Loading chromatogram...</p></div>');
                        $(loadingPan).appendTo(cardPlotDiv);
                        cardPlotDiv.show();
                        if (cardPlotDiv.attr('content-displayed') == 'none'){
                            loadingPan.toggle('slow');
                        }
                        else{
                            chromatogramPlotDiv.hide();
                            loadingPan.show();
                        }
                        console.log(peakID);
                        console.log("before toggle");
                        console.log(intensityPlotDiv);

                        // Make the ajax call for the intensity plot
                        var data = {"id": peakID};
                        var url = "{% url 'get_peak_info_peak_id' project.id analysis.id %}";
                        $.ajax({
                            type: "GET",
                            traditional : true,
                            url: url,
                            data: data,
                            success: function(response) {
                                // Empty the intensityPlotDiv
                                // intensityPlotDiv.empty();

                                // And fill the div with the intensity plot
                                var chartWidth = $(cardPlotDiv).width() - 10;
                                console.log(chartWidth);
                                averageIntensityChartFromCompound(chartWidth, intensityPlotDiv, response);
                                intensityPlotDiv.attr('data-exist', 'true');

                                // Remove the loading graphic
                                loadingPan.remove();
                                // if (intensityPlotDiv.css('display') == 'none'){
                                if (cardPlotDiv.attr('content-displayed') == 'none'){
                                    // intensityPlotDiv.show();
                                    intensityPlotDiv.toggle('slow');
                                    console.log("data doesn't exist and content-displayed == none");
                                    cardPlotDiv.attr('content-displayed','intensity');
                                    // cardPlotDiv.toggle('slow');
                                }
                                else {
                                    chromatogramPlotDiv.hide();
                                    intensityPlotDiv.show();
                                    cardPlotDiv.attr('content-displayed','intensity');
                                    console.log("content display == "+cardPlotDiv.attr('content-displayed'));
                                    if (cardPlotDiv.css('display') == 'none'){
                                        cardPlotDiv.toggle('slow');
                                    }
                                }
                                
                                // }
                            },
                            error: function() {
                                alert("Error with average intensity plot in metabolites tab");
                            }
                        });
                    }
                })
                .on('click', '.identified_peak_marker', function(e){

                    // Override the event to stop any action e.g. form submission
                    e.preventDefault();

                    // Get the associated peak secondaryID
                    var peakID = $(this).prop('id').split("-")[1];

                    // Get the note div to display
                    var noteDiv = $('#identified-note-peak-'+peakID);

                    // Function that closes the note div when called
                    function closeDiv(){
                        noteDiv.toggle('slow');
                    }

                    // Open the note div
                    noteDiv.toggle('slow');

                    // Call the close div function after 4 seconds (the information doesn't need to be displayed once read - maybe annyoing for very super slow readers...)
                    setTimeout(closeDiv, 4000);

                })
                .on('click', '.annotated_compound_number', function(e){
                    console.log("blablablabla");
                    // Override the event to stop any action e.g. form submission
                    e.preventDefault();

                    // Get the associated peak secondaryID
                    var peakID = $(this).prop('id').split("-")[1];

                    // Get the note div to display
                    var noteDiv = $('#annotation_number_note-'+peakID);

                    // Function that closes the note div when called
                    function closeDiv(){
                        noteDiv.toggle('slow');
                    }

                    // Open the note div
                    noteDiv.toggle('slow');

                    // Call the close div function after 4 seconds (the information doesn't need to be displayed once read - maybe annyoing for very super slow readers...)
                    setTimeout(closeDiv, 4000);

                })
                .on('click', '.pathway-coverage-btn', function(e) {
                    // Create pie chart for the pathway coverage or hide it if already displayed

                    // Override the event to stop any action e.g. form submission
                    e.preventDefault();

                    // Get the div to display the chart
                    var pieChartDiv = $('#card-content-pathway-coverage');

                    // if the chart exist then hide or show it (depending on its current state)
                    if (pieChartDiv.attr('data-exist') == 'true'){
                        pieChartDiv.toggle('slow');
                    }
                    // else create the chart and display it
                    else {
                        var chartWidth = $('#card-content-pathway-coverage').width()-10;

                        // Create pie chart with the data stored in a global variable 'pathwayCoverageData'
                        pieChart(chartWidth, pieChartDiv, pathwayCoverageData, 400);

                        // Change the attribute of the div to know that chart now exists (no need to recreate it in the future)
                        pieChartDiv.attr('data-exist', 'true');
                        
                        // Display the chart using slide down of the div
                        pieChartDiv.toggle('slow');
                    }


                })
                .on('click', '.peak-metabolites-chromatogram-btn', function(e) {
                    // Creates the chromatogram, which is used to replace the associated button

                    // Override the event to stop any action e.g. form submission
                    e.preventDefault();

                    // Get the associated peak secondaryID
                    var peakID = $(this).prop('id').split("-")[1];

                    // Get the correct div to insert the chromatogram
                    // var chromatogramDiv = $(this).closest('.metabolites-chromatogram-div');
                    var cardPlotDiv = $('#peakcard-content-peak-'+peakID);

                    var intensityPlotDiv = $('#peakcard-intensity-'+peakID);

                    var chromatogramPlotDiv = $('#peakcard-chromatogram-'+peakID);

                    // Remove the button and replace with a loading image
                    // $(this).remove();

                    if (chromatogramPlotDiv.attr('data-exist') == 'true'){
                        if (cardPlotDiv.attr('content-displayed') == 'chromatogram'){
                            cardPlotDiv.toggle('slow');
                        }
                        else {
                            intensityPlotDiv.hide();
                            chromatogramPlotDiv.show();
                            cardPlotDiv.attr('content-displayed','chromatogram');
                            if (cardPlotDiv.css('display') == 'none'){
                                cardPlotDiv.toggle('slow');
                            }
                        }
                    }
                    else {
                        var loadingPan = $('<div class="span12" style="margin-left: 0px; margin-top: 20px; cursor: progress;display:none;"><img src="{{ STATIC_URL }}img/Poly-logo_speed4.gif" alt="loading" style="text-align: center; margin: auto;"><p style="text-align: center;">Loading chromatogram...</p></div>');
                        $(loadingPan).appendTo(cardPlotDiv);
                        cardPlotDiv.show();
                        if (cardPlotDiv.attr('content-displayed') == 'none'){
                            loadingPan.toggle('slow');
                        }
                        else{
                            intensityPlotDiv.hide();
                            loadingPan.show();
                        }
                        
                        // Make the AJAX call for the chromatogram
                        var data = {"id": peakID, "ppm": ppm, "rtwindow": rtwindow};
                        var url = "{% url 'get_peaks_from_peak_id' project.id analysis.id %}";

                        $.ajax({
                            type: "GET",
                            traditional : true,
                            url: url,
                            data: data,
                            success: function(response){
                                // Empty the chromatogramDiv
                                // chromatogramDiv.empty();

                                // And fill the div with the chromatogram
                                var chartWidth = $(cardPlotDiv).width() - 10;

                                createPeaksChromatogram(chartWidth, chromatogramPlotDiv, response);

                                chromatogramPlotDiv.attr('data-exist', 'true');

                                // Remove the loading graphic
                                loadingPan.remove();
                                // if (intensityPlotDiv.css('display') == 'none'){
                                if (cardPlotDiv.attr('content-displayed') == 'none'){
                                    // chromatogramPlotDiv.show();
                                    chromatogramPlotDiv.toggle('slow');
                                    console.log("data doesn't exist and content-displayed == none");
                                    cardPlotDiv.attr('content-displayed','chromatogram');
                                    // cardPlotDiv.toggle('slow');
                                }
                                else {
                                    // intensityPlotDiv.hide();
                                    chromatogramPlotDiv.show();
                                    cardPlotDiv.attr('content-displayed','chromatogram');
                                    console.log("content display == "+cardPlotDiv.attr('content-displayed'));
                                    if (cardPlotDiv.css('display') == 'none'){
                                        cardPlotDiv.toggle('slow');
                                    }
                                }
                            },
                            error: function(){
                                alert("Error with chromatogram in metabolites tab");
                            }
                        });
                    }
                })
                .on('click', '.peak-metabolites-intensity-plot-btn', function(e) {
                    // Override the event to stop any action e.g. form submission
                    e.preventDefault();

                    // Get the associated peak secondaryID
                    var peakID = $(this).prop('id').split("-")[1];

                    // Get the correct div to insert the intensity plot
                    // var intensityPlotDiv = $(this).closest('.card-content');
                    var cardPlotDiv = $('#peakcard-content-peak-'+peakID);

                    var intensityPlotDiv = $('#peakcard-intensity-'+peakID);

                    var chromatogramPlotDiv = $('#peakcard-chromatogram-'+peakID);

                    // Remove the button and replace with a loading image
                    // $(this).remove();

                    if (intensityPlotDiv.attr('data-exist') == 'true'){
                        if (cardPlotDiv.attr('content-displayed') == 'intensity'){
                            cardPlotDiv.toggle('slow');
                        }
                        else {
                            chromatogramPlotDiv.hide();
                            intensityPlotDiv.show();
                            cardPlotDiv.attr('content-displayed','intensity');
                            if (cardPlotDiv.css('display') == 'none'){
                                cardPlotDiv.toggle('slow');
                            }
                        }
                    }
                    else {
                        var loadingPan = $('<div class="span12" style="margin-left: 0px; margin-top: 20px; cursor: progress;"><img src="{{ STATIC_URL }}img/Poly-logo_speed4.gif" alt="loading" style="text-align: center; margin: auto;"><p style="text-align: center;">Loading chromatogram...</p></div>');
                        $(loadingPan).appendTo(cardPlotDiv);
                        cardPlotDiv.show();
                        if (cardPlotDiv.attr('content-displayed') == 'none'){
                            loadingPan.toggle('slow');
                        }
                        else{
                            chromatogramPlotDiv.hide();
                            loadingPan.show();
                        }
                        console.log(peakID);
                        console.log("before toggle");
                        console.log(intensityPlotDiv);

                        // Make the ajax call for the intensity plot
                        var data = {"id": peakID};
                        var url = "{% url 'get_peak_info_peak_id' project.id analysis.id %}";
                        $.ajax({
                            type: "GET",
                            traditional : true,
                            url: url,
                            data: data,
                            success: function(response) {
                                // Empty the intensityPlotDiv
                                // intensityPlotDiv.empty();

                                // And fill the div with the intensity plot
                                var chartWidth = $(cardPlotDiv).width() - 10;
                                console.log(chartWidth);
                                averageIntensityChartFromCompound(chartWidth, intensityPlotDiv, response);
                                intensityPlotDiv.attr('data-exist', 'true');

                                // Remove the loading graphic
                                loadingPan.remove();
                                // if (intensityPlotDiv.css('display') == 'none'){
                                if (cardPlotDiv.attr('content-displayed') == 'none'){
                                    // intensityPlotDiv.show();
                                    intensityPlotDiv.toggle('slow');
                                    console.log("data doesn't exist and content-displayed == none");
                                    cardPlotDiv.attr('content-displayed','intensity');
                                    // cardPlotDiv.toggle('slow');
                                }
                                else {
                                    chromatogramPlotDiv.hide();
                                    intensityPlotDiv.show();
                                    cardPlotDiv.attr('content-displayed','intensity');
                                    console.log("content display == "+cardPlotDiv.attr('content-displayed'));
                                    if (cardPlotDiv.css('display') == 'none'){
                                        cardPlotDiv.toggle('slow');
                                    }
                                }
                                
                                // }
                            },
                            error: function() {
                                alert("Error with average intensity plot in metabolites tab");
                            }
                        });
                    }
                });

			function updateMetabolitesRightPanel(rowInfo, innerSidePanel) {
                // Function to add metabolite information to the right side pane in the metabolites tab, where the
                // metabolite information is taken from the metabolite row that is clicked in the main table.
                // more info...
				$(innerSidePanel).empty();
				var averageChart = false;
				var peaksChart = false;
				var newEvidenceDom = '';
				var evidencePanel = $('<div class="span12" id="metabolitesSideEvidencePanel"><h3 class="right-side-title evidence-title">Evidence</h3></div>');

				$(evidencePanel).appendTo($(innerSidePanel));

                // Structure for the compound

                console.log(rowInfo);

                var data = {"id":rowInfo[0]};

				var url = "{% url 'get_compound_info' project.id analysis.id %}";

				$.ajax({
					type: "GET",
					traditional : true,
		            url: url,
		            data: data,
		            success: function(response){
		            	var database_info = {};
		            	for (var i=3;i<response.length;i++){
		            		database_info[response[i][0]] = [response[i][1],response[i][2]];
		            	}
		            	$(evidencePanel).append('<div class="card"><div class="span12 card-title__click" id="compound-card-title" style="margin-left:0px;"><h5 class="right-side-title">Compound</h5><span class="card-face__title"></span></div><div class="span12 structure card-content" id="compound-card-content" style="margin-left:0px;display:none;"></div><div class="span12 compound_name" style="margin-left:0px;"></div><div class="span12" style="margin-left:0px;padding-left:13px;margin-top:10px;"><span class="span6" style="padding-top: 7px;">Database</span><select class="span4 db_selector" style="float: right;margin-right: 10px;"></select></div></div>');
		            	for (var index in database_info){
		            		$('.db_selector').append('<option value="'+index+'">'+index+'</option>');
		            	}
		            	// $(evidencePanel).append('</select></div><div class="span12 structure" style="margin-left:0px;"></div>');
                        var loadingPan = $('<div class="span12" style="margin-left: 0px; margin-top: 20px; cursor: progress;"><img src="{{ STATIC_URL }}img/Poly-logo_speed4.gif" alt="loading" style="text-align: center; margin: auto;"><p style="text-align: center;">Loading structure...</p></div>');
		            	$(loadingPan).appendTo(evidencePanel);
		            	var structureDom;
		            	if ($('select.db_selector').val() == "hmdb"){
		            		structureDom = $('<img style="margin: auto;float: none; display: block;" src="http://structures.wishartlab.com/molecules/'+database_info["hmdb"][1]+'/image.png" alt="Compound structure"><span class="card-face__title"></span>');
                            nameDom = $('<span id="compound-name">'+database_info["hmdb"][0]+'</span><span class="card-face__bottom"></span>');
		            	}
		            	else if ($('select.db_selector').val() == "kegg"){
		            		structureDom = $('<img style="margin: auto;float: none; display: block;" src="http://www.kegg.jp/Fig/compound/'+database_info["kegg"][1]+'.gif" alt="Compound structure"><span class="card-face__title"></span>');
                            nameDom = $('<span id="compound-name">'+database_info["kegg"][0]+'</span><span class="card-face__bottom"></span>');
		            	}
		            	else if ($('select.db_selector').val() == "lipidmaps"){
		            		structureDom = $('<img style="margin: auto;float: none; display: block;" src="http://www.lipidmaps.org/data/LMSDRecord.php?Mode=LMGIFImage&LMID='+database_info["lipidmaps"][1]+'" alt="Compound structure"><span class="card-face__title"></span>');
                            nameDom = $('<span id="compound-name">'+database_info["lipidmaps"][0]+'</span><span class="card-face__bottom"></span>');
		            	}
		            	else {
		            		structureDom = $('<p>Structure not available</p>');
                            nameDom = $('<span id="compound-name">'+database_info["stds_db"][0]+'</span><span class="card-face__bottom"></span>');
		            	}

                        $('#compound-card-title').click(function(){
                                $('#compound-card-content').toggle('slow');
                            });
                        
                        // Add pathway card
                        if (response[2] != null){
                            $(evidencePanel).append('<div class="card"><div class="span12 card-title__click" id="pathway-card-title" style="margin-left:0px;"><h5 class="right-side-title">Pathways<span style="float:right;margin-right:10px;color: rgb(112, 158, 241);">'+response[2].length+'</span></h5></div><div class="span12" id="pathway-card-content" style="display:none;"><ul id="metabolite_pathway_list"></ul></div></div>');
                            for (var i=0;i<response[2].length;i++){
                                console.log(response[2][i]);
                                if (i % 2 == 0){
                                    $('#metabolite_pathway_list').append('<li>'+response[2][i]+'</li>');
                                }
                                else {
                                    $('#metabolite_pathway_list').append('<li style="color: rgb(112, 158, 241);">'+response[2][i]+'</li>');
                                }
                            }
                            $('#pathway-card-title').click(function(){
                                $('#pathway-card-content').toggle('slow');
                            });
                        }
                        else{
                            $(evidencePanel).append('<div class="card"><div class="span12 card-title__click" id="pathway-card-title" style="margin-left:0px;"><h5 class="right-side-title">Pathways<span style="float:right;margin-right:10px;color: rgb(112, 158, 241);">0</span></h5></div><div class="span12" id="pathway-card-content" style="display:none;"><ul id="metabolite_pathway_list"></ul></div></div>');
                        }
                        $(loadingPan).remove();

		            	var structureDiv = $('.structure');
		            	$(structureDom).appendTo($(structureDiv));

                        var compoundNameDiv = $('.compound_name');
                        $(nameDom).appendTo($(compoundNameDiv));

		            	$('select.db_selector').change(function (){
		            		$('select.db_selector').val($(this).val());
		            		if ($(this).val() == "hmdb"){
		            		    structureDom = $('<img style="margin: auto;float: none; display: block;" src="http://structures.wishartlab.com/molecules/'+database_info["hmdb"][1]+'/image.png" alt="Compound structure"><span class="card-face__bottom"></span>');
                                nameDom = $('<span id="compound-name">'+database_info["hmdb"][0]+'</span><span class="card-face__bottom"></span>');
			            	}
			            	else if ($(this).val() == "kegg"){
			            		structureDom = $('<img style="margin: auto;float: none; display: block;" src="http://www.kegg.jp/Fig/compound/'+database_info["kegg"][1]+'.gif" alt="Compound structure"><span class="card-face__bottom"></span>');
                                nameDom = $('<span id="compound-name">'+database_info["kegg"][0]+'</span><span class="card-face__bottom"></span>');
			            	}
			            	else if ($(this).val() == "lipidmaps"){
		            			structureDom = $('<img style="margin: auto;float: none; display: block;" src="http://www.lipidmaps.org/data/LMSDRecord.php?Mode=LMGIFImage&LMID='+database_info["lipidmaps"][1]+'" alt="Compound structure"><span class="card-face__bottom"></span>');
                                nameDom = $('<span id="compound-name">'+database_info["lipidmaps"][0]+'</span><span class="card-face__bottom"></span>');
		            		}
			            	else {
			            		structureDom = $('<p>Structure not available</p><span class="card-face__bottom"></span>');
                                nameDom = $('<span id="compound-name">'+database_info["stds_db"][0]+'</span><span class="card-face__bottom"></span>');
			            	}
                            // $('#compound-card-content').toggle('slow');
			            	$(structureDiv).empty();
			            	$(structureDom).appendTo($(structureDiv));
                            // $('#compound-card-content').toggle('slow');
                            $(compoundNameDiv).empty();
                            $(nameDom).appendTo($(compoundNameDiv));
			            });
		            },
		            error: function(){
		        		alert("Error");
		        	}
		        });

                // Peak information for the compound
                var data = {"compound_id": rowInfo[0]};
				var url = "{% url 'get_metabolite_info' project.id analysis.id %}";

				$.ajax({
				    type: "GET",
				    traditional : true,
                    url: url,
                    data: data,
                    dataType: "json",
		            success: function(response){
                        var peaksData = response["aaData"];
                        $.each(peaksData, function(peakDataId) {
                            // Creates a peakDiv for every peak that is associated with the compound. The id of the peakDiv is set to peak.secondaryID for ease of access. $('#evidencePanel #1')
                            var peakDiv = $('<div class="card peak-div" id="peak-'+peaksData[peakDataId][0]+'"></div>');

                            // If there is more than one peak, add the peak number to the peakDiv
                            if (peaksData.length > 1) {
                                // If the peak identified then add the "identified PiMP icon" and the explanative note div
                                if (peaksData[peakDataId][7] == true) {
                                    peakDiv.append('<div class="span12 card-title" id="peak-card-title" style="margin-left:0px;"><h5 class="right-side-title">Peak #'+(peakDataId + 1)+'<span class="identified_peak_marker" id="identified_peak-'+peaksData[peakDataId][0]+'" style="float:right;margin-right:10px;"><img src="{{ STATIC_URL }}img/PiMP_logo_compound_id.svg" width="20" height="20" draggable="false"></span><span class="annotated_compound_number" id="annotated_compound_number-'+peaksData[peakDataId][0]+'" style="float:right;margin-right:10px;color: rgb(112, 158, 241);">'+peaksData[peakDataId][8]+'</span></h5><span class="card-face__title"></span></div><div class="span12" id="identified-note-peak-'+peaksData[peakDataId][0]+'" style="display:none;"><span class="span12 standard-note" style="padding-top: 8px;line-height: 12px;padding-right: 5px;">This peak matches the standard compound peak</span></div><div class="span12" id="annotation_number_note-'+peaksData[peakDataId][0]+'" style="display:none;"><span class="span12 standard-note" style="padding-top: 8px;line-height: 12px;padding-right: 5px;">This peak annotates '+peaksData[peakDataId][8]+' other compounds</span></div>');
                                }
                                else {
                                    peakDiv.append('<div class="span12 card-title" id="peak-card-title" style="margin-left:0px;"><h5 class="right-side-title">Peak #'+(peakDataId + 1)+'<span class="annotated_compound_number" id="annotated_compound_number-'+peaksData[peakDataId][0]+'" style="float:right;margin-right:10px;color: rgb(112, 158, 241);">'+peaksData[peakDataId][8]+'</span></h5><span class="card-face__title"></span></div><div class="span12" id="annotation_number_note-'+peaksData[peakDataId][0]+'" style="display:none;"><span class="span12 standard-note" style="padding-top: 8px;line-height: 12px;padding-right: 5px;">This peak annotates '+peaksData[peakDataId][8]+' other compounds</span></div>');
                                }
                            }
                            else {
                                // If the peak identified then add the "identified PiMP icon" and the explanative note div
                                if (peaksData[peakDataId][7] == true) {
                                    peakDiv.append('<div class="span12 card-title" id="peak-card-title" style="margin-left:0px;"><h5 class="right-side-title">Peak<span class="identified_peak_marker" id="identified_peak-'+peaksData[peakDataId][0]+'" style="float:right;margin-right:10px;"><img src="{{ STATIC_URL }}img/PiMP_logo_compound_id.svg" width="20" height="20" draggable="false"></span><span class="annotated_compound_number" id="annotated_compound_number-'+peaksData[peakDataId][0]+'" style="float:right;margin-right:10px;color: rgb(112, 158, 241);">'+peaksData[peakDataId][8]+'</span></h5><span class="card-face__title"></span></div><div class="span12" id="identified-note-peak-'+peaksData[peakDataId][0]+'" style="display:none;"><span class="span12 standard-note" style="padding-top: 8px;line-height: 12px;padding-right: 5px;">This peak matches the standard compound peak</span></div><div class="span12" id="annotation_number_note-'+peaksData[peakDataId][0]+'" style="display:none;"><span class="span12 standard-note" style="padding-top: 8px;line-height: 12px;padding-right: 5px;">This peak annotates '+peaksData[peakDataId][8]+' other compounds</span></div>');
                                }
                                else {
                                    peakDiv.append('<div class="span12 card-title" id="peak-card-title" style="margin-left:0px;"><h5 class="right-side-title">Peak<span class="annotated_compound_number" id="annotated_compound_number-'+peaksData[peakDataId][0]+'" style="float:right;margin-right:10px;color: rgb(112, 158, 241);">'+peaksData[peakDataId][8]+'</span></h5><span class="card-face__title"></span></div><div class="span12" id="annotation_number_note-'+peaksData[peakDataId][0]+'" style="display:none;"><span class="span12 standard-note" style="padding-top: 8px;line-height: 12px;padding-right: 5px;">This peak annotates '+peaksData[peakDataId][8]+' other compounds</span></div>');
                                }
                            }

                            // Add all info about the peak - two per line - odd and even lines have different colours for clarity
                            peakDiv.append('<span class="span5 peak-info peak-info-odd" style="padding-top: 8px;line-height: 12px;"><strong>RT (s)</strong>: '+peaksData[peakDataId][1]+'</span>');
                            peakDiv.append('<span class="span5 peak-info peak-info-odd" style="padding-top: 8px;line-height: 12px;"><strong>Mass</strong>: '+peaksData[peakDataId][2]+'</span>');
                            peakDiv.append('<span class="span5 peak-info peak-info" style="padding-top: 4px;line-height: 12px;"><strong>Polarity</strong>: '+peaksData[peakDataId][3]+'</span>');
                            peakDiv.append('<span class="span5 peak-info peak-info" style="padding-top: 4px;line-height: 12px;"><strong>Type</strong>: '+peaksData[peakDataId][4]+'</span>');
                            peakDiv.append('<span class="span5 peak-info peak-info-odd" style="line-height: 12px;"><strong>Ion</strong>: '+peaksData[peakDataId][5]+'</span>');
                            peakDiv.append('<span class="span5 peak-info peak-info-odd" style="line-height: 12px;"><strong>ppm error</strong>: '+peaksData[peakDataId][6]+'</span>');
                            peakDiv.append('<div class="span12" style="min-height:10px;"><span class="card-face__title"></span></div>');

                            // Div where the plots are displayed
                            peakDiv.append('<div class="span12" id="card-content-peak-'+peaksData[peakDataId][0]+'" content-displayed="none" style="margin-left:0px;display:none;"><div class="span12" data-exist="false" id="card-intensity-'+peaksData[peakDataId][0]+'" style="display:none;"></div><div class="span12" data-exist="false" id="card-chromatogram-'+peaksData[peakDataId][0]+'" style="display:none;"></div></div>');

                            // Add the buttons for the plots - clicks are handled in separate function using div ids
                            peakDiv.append('<div class="span12" style="padding-bottom:14px;"><div class="card-face-footer"><span class="card-face__social metabolites-chromatogram-btn" id="peak-'+peaksData[peakDataId][0]+'"><img src="{{ STATIC_URL }}img/chromatogram_icon.svg" width="36" height="36" draggable="false"></span><span  class="card-face__social metabolites-intensity-plot-btn" id="peak-'+peaksData[peakDataId][0]+'"><img src="{{ STATIC_URL }}img/intensity_icon.svg" width="36" height="36" draggable="false"></span></div>');

                            // Finally, add the peakDiv to the evidencePanel
                            $(evidencePanel).append(peakDiv);
                            });
		            },
                    error: function(){
		         	    alert("Error with getting peak information");
		        	}
		        });


            }

			function createPeaksChromatogram(chartWidth, div, response){

            	polarity = response[0][0]
            	retentionTime = response[0][1]
            	mass = response[0][2]
            	// Begining of chart
            	$(div).highcharts({
            		credits : {
						enabled : false
					},
		        	chart: {
		                zoomType: 'x',
		                // spacingRight: 20,
		                width: chartWidth,
		                height: 400,
		                backgroundColor: '#FFFFFF',
		                plotBackgroundColor: null,
		                plotBorderWidth: null,
		                plotShadow: false,
		                events: {
							click: function (event) {
                				event.preventDefault();
		                        if(($(event.target)[0].textContent) != "Reset zoom"){
		                        	peaksChromatogramPopUp(mass, retentionTime, response);
		                        }
		                    }
						}
		            },
		            title: {
		                text: 'Peak chromatogram'
		            },
		            subtitle: {
		                text: 'Mass: '+parseFloat(mass).toFixed(4)+' ppm: '+ppm
		            },
		            exporting: {
			           	enabled: true,
			        },
		            xAxis: {
		                title: {
		                    text: 'Retention time (s)'
		                },
                		showLastLabel: true
		            },
		            yAxis: {
		                title: {
		                    text: 'Measured abundance'
		                },
		                min: 0,
		            },
		            tooltip: {
		                shared: true,
		                headerFormat: '',
		                pointFormat: '<span style="font-size: 10px;font-weight: bold;color:{point.series.color}">{series.name}</span><br/>Retention time: {point.x}<br/>Intensity: {point.y}<br/>'

		            },
		            legend: {
		                enabled: true
		            },
		    		plotOptions: {
		                area: {
		                    marker: {
		                        enabled: false,
		                        symbol: 'circle',
		                        radius: 2,
		                        states: {
		                            hover: {
		                                enabled: true
		                            }
		                        }
		                    },
		                    lineWidth: 1,
		                    shadow: false,
		                    states: {
		                        hover: {
		                            lineWidth: 1
		                        }
		                    },
		                    threshold: null
		                },
		                series: {
            				fillOpacity: 0.1
            			}
		            },
		            series: [{
		                type: 'area',
		                name: response[1][0],
		                data : response[1][1]
		            }]
	    		});
				for (var i=2;i<response.length;i++){
        			$(div).highcharts().addSeries({
        				type: 'area',
	                	name: response[i][0],
	                	data : response[i][1]
        			});
        		}
    			for (var i=0;i<$(div).highcharts().series.length;i++){
    				if ($(div).highcharts().series[i].data.length == 0) {
    					$(div).highcharts().series[i].hide();
    				}
    			}
            	// End of chart
			}

			function compare(a,b) {
			  if (a.index < b.index)
			     return -1;
			  if (a.index > b.index)
			    return 1;
			  return 0;
			}

			function averageIntensityChartFromCompound(chartWidth, div, response){
				var data = response["samples"];
				var blank_data = response["blanks"];
				var categories = [];
				var average = [];
				var errorBar = [];
				var drilldownSeries = [];
				var drilldownData = [];
				for (var i=0;i<data.length;i++){
					categories.push(data[i][0]);
					average.push({
						name: data[i][0],
						// id: data[i][0],
						index: memberColumnIndex[data[i][0]],
						y: data[i][1],
						drilldown: data[i][0]+"1"
					});
					drilldownData = [];
					for (var j=0;j<data[i][3][0].length;j++){
						drilldownData.push({
							name: data[i][3][1][j],
							y: data[i][3][0][j]
						});
					}
					drilldownSeries.push({
						name: data[i][0],
						id: data[i][0]+"1",
						data: drilldownData
					});
					erroBarPoint = [data[i][1]-data[i][2],data[i][1]+data[i][2]]
					errorBar.push({
						low: erroBarPoint[0],
						high: erroBarPoint[1],
						index: memberColumnIndex[data[i][0]]
					});
				}
				if (blank_data){
					categories.push(blank_data[0]);
					average.push({
						name: blank_data[0],
						// id: data[i][0],
						color: '#FF5757',
						index: blankColumnIndex,
						y: blank_data[1],
						drilldown: blank_data[0]+"1"
					});
					drilldownData = [];
					for (var j=0;j<blank_data[3][0].length;j++){
						drilldownData.push({
							name: blank_data[3][1][j],
							color: '#FF5757',
							y: blank_data[3][0][j]
						});
					}
					drilldownSeries.push({
						name: blank_data[0],
						id: blank_data[0]+"1",
						data: drilldownData
					});
					erroBarPoint = [blank_data[1]-blank_data[2],blank_data[1]+blank_data[2]]
					errorBar.push({
						low: erroBarPoint[0],
						high: erroBarPoint[1],
						index: blankColumnIndex
					});
				}
				average.sort(compare);
				errorBar.sort(compare);
				$(div).highcharts({
					credits : {
						enabled : false
					},
		            chart: {
		            	type: averageChartType,
		            	width: chartWidth,
		            	// backgroundColor: '#f5f5f5',
                        backgroundColor: '#FFFFFF',
		                plotBackgroundColor: null,
		                plotBorderWidth: null,
		                plotShadow: false,
		                events: {
							click: function (event) {
                				event.preventDefault();
		                        if(($(event.target)[0].textContent) != "Reset zoom" && ($(event.target)[0].textContent) != "◁ Back to Intensity"){
		                        	averagePopUp(categories, average, errorBar);
		                        }
		                    }
						}

		            },
		            title: {
		                text: 'Intensity comparison',
		            },
		            exporting: {
			           	enabled: averageExport,
			        },
		            xAxis: {
		            	type: 'category',
						labels: {
                    		rotation: -45,
                    		align: 'right'
                    	}
					},
					yAxis: [{ // Secondary yAxis
						title: {
							text: 'Relative abundance',
						},
						labels: {
							formatter: function() {
								return this.value.toExponential();
							},
						},
					}],
					legend: {
                    	enabled: false
                	},
		            tooltip: {
		        	    shared: true,
		        	    valueDecimals: 2
		            },
		            series: [{
					    // showInLegend: false,
						name: 'Intensity',
						// color: '#4572A7',
						type: averageChartType,
						data: average,
						// tooltip: {
						// 	pointFormat: '<span style="font-weight: bold; color: {series.color}">{series.name}</span>: <b>{point.y:.1f}</b><br/>'
						// }
					}, {
						name: 'Standard deviation',
						type: 'errorbar',
						data: errorBar,
						tooltip: {
						// 	// formatter:function(a,b,c){
						// 	// 	'<span style="font-weight: bold; color: {series.color}"></span>:<br/>'
						// 	// },
							pointFormat:'' //'<span style="font-weight: bold; color: {series.color}">{series.name}</span>:<br/>'
						}
					}],
					drilldown: {
            			series: drilldownSeries
            		}
		        });

			}

			function updateRightPanel(rowInfo, header, innerSidePanel){
				$(innerSidePanel).empty();
				var newDom = '<div class="span12"><h3 class="right-side-title">Evidence</h3></div>';
                console.log('dans la fonction');
				for (var i=0;i<rowInfo.length;i++){
					if (header[i] == "Coverage"){
						newDom += '<div class="span12" style="margin-left:0px;"><h5 class="right-side-title">'+header[i]+'</h5></div><div class="span12" style="margin-left:0px;padding-left:13px;"><p>'+rowInfo[i]+'%</p></div>';
					}
					else {
					newDom += '<div class="span12" style="margin-left:0px;"><h5 class="right-side-title">'+header[i]+'</h5></div><div class="span12" style="margin-left:0px;padding-left:13px;"><p>'+rowInfo[i]+'</p></div>';
					}
				}
				$(newDom).appendTo($(innerSidePanel));
			}

            function updatePeakRightPanel(rowInfo, header, innerSidePanel){
                $(innerSidePanel).empty();
                var newDom = '<div class="span12"><h3 class="right-side-title evidence-title">Evidence</h3></div>';
                console.log('dans la fonction pathway');
                newDom += '<div class="card"><div class="span12 card-title" style="margin-left:0px;"><h5 class="right-side-title">Peak</h5><span class="card-face__title"></span></div><span class="span5 peak-info peak-info-odd" style="padding-top: 8px;line-height: 12px;"><strong>Id</strong>: '+ rowInfo[0] +'</span><span class="span5 peak-info peak-info-odd" style="padding-top: 8px;line-height: 12px;"><strong>RT (s)</strong>: '+ rowInfo[2] +'</span><span class="span5 peak-info peak-info" style="padding-top: 4px;line-height: 12px;"><strong>Mass</strong>: '+ rowInfo[1] +'</span><span class="span5 peak-info peak-info" style="padding-top: 4px;line-height: 12px;"><strong>Polarity</strong>: '+ rowInfo[3] +'</span><div class="span12" style="min-height:10px;margin-left:0px"><span class="card-face__title"></span></div>';

                // Div where the plots are displayed
                newDom += '<div class="span12" id="peakcard-content-peak-'+ rowInfo[0] +'" content-displayed="none" style="margin-left:0px;display:none;"><div class="span12" data-exist="false" id="peakcard-intensity-'+ rowInfo[0] +'" style="display:none;"></div><div class="span12" data-exist="false" id="peakcard-chromatogram-'+ rowInfo[0] +'" style="display:none;"></div></div>';

                // Add the buttons for the plots - clicks are handled in separate function using div ids
                newDom += '<div class="span12" style="padding-bottom:14px;"><div class="card-face-footer"><span class="card-face__social peak-metabolites-chromatogram-btn" id="peak-'+ rowInfo[0] +'"><img src="{{ STATIC_URL }}img/chromatogram_icon.svg" width="36" height="36" draggable="false"></span><span  class="card-face__social peak-metabolites-intensity-plot-btn" id="peak-'+ rowInfo[0] +'"><img src="{{ STATIC_URL }}img/intensity_icon.svg" width="36" height="36" draggable="false"></span></div></div>';

                $(newDom).appendTo($(innerSidePanel));
            }

            function updatePathwayRightPanel(rowInfo, header, innerSidePanel){
                $(innerSidePanel).empty();
                var newDom = '<div class="span12"><h3 class="right-side-title evidence-title">Evidence</h3></div>';
                console.log('dans la fonction pathway');
                newDom += '<div class="card"><div class="span12 card-title" id="pathway-card-title" style="margin-left:0px;"><h5 class="right-side-title">Pathway</h5><span class="card-face__title"></span></div><div class="span12 pathway_name" style="margin-left:0px;"><span id="pathway-name">'+ rowInfo[0] +'</span><span class="card-face__bottom"></span></div><div class="span12" id="kegg-btn-div" style="margin-left:0px;padding-left:13px;margin-top:10px;"></div></div>';
                
                newDom += '<div class="card"><div class="span12 card-title" id="pathway-card-title" style="margin-left:0px;"><h5 class="right-side-title">Coverage<span style="float:right;margin-right:10px;color: rgb(112, 158, 241);">'+rowInfo[5]+'%</span></h5><span class="card-face__title"></span></div><div class="span12" id="card-content-pathway-coverage" data-exist="false" style="margin-left:0px;display:none;"></div><div class="span12" style="padding-bottom:14px;margin-top: 10px;"><div class="card-face-footer"><span class="card-face__social pathway-coverage-btn"><img src="{{ STATIC_URL }}img/pie_chart.svg" width="36" height="36" draggable="false"></span></div></div>';

                $(newDom).appendTo($(innerSidePanel));
            }

			function averagePopUp(categories, average, errorBar){
				var $modal = $("#full-width");

				var modalBody = $modal.find('.modal-body');
				var modalFooter = $modal.find('.modal-footer');
				var modalHeader = $modal.find('.modal-header');




				$(modalHeader).empty();
				$(modalLabel).empty();
				$(modalBody).empty();
				$(modalFooter).empty();

				$('<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>').appendTo($(modalFooter));
				$('<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button><h3 id="myModalLabel"></h3>').appendTo($(modalHeader));
				var modalLabel = $modal.find('#myModalLabel');
				$(modalLabel).text("Intensity comparison");
				var chartWidth = $modal.width();
				$(modalBody).highcharts({
					credits : {
						enabled : false
					},
		            chart: {
		            	width: chartWidth,
		                plotBackgroundColor: null,
		                plotBorderWidth: null,
		                plotShadow: false,
		            },
		            title: {
		                text: 'Intensity comparison',
		            },
		            exporting: {
			           	enabled: true,
			           	filename: 'intensity_comparison'
			        },
		            xAxis: {
						type: 'category',
						labels: {
                    		rotation: -45,
                    		align: 'right'
                    	}
					},
					yAxis: [{ // Secondary yAxis
						title: {
							text: 'Relative abundance',
						},
						labels: {
							formatter: function() {
								return this.value;
							},
						},
					}],
		            tooltip: {
		        	    shared: true,
		        	    valueDecimals: 2
		            },
		            series: [{
					    showInLegend: false,
						name: 'Intensity',
						// color: '#4572A7',
						type: 'column',
						data: average,
						tooltip: {
							pointFormat: '<span style="font-weight: bold; color: {series.color}">{series.name}</span>: <b>{point.y:.1f}</b><br/>'
						}
					}, {
						name: 'Standard deviation',
						type: 'errorbar',
						data: errorBar,
						tooltip: {
							pointFormat:'' //'<span style="font-weight: bold; color: {series.color}">{series.name}</span>:<br/>'
						}
					}]
		        });
				$modal.modal();
			}

			function peaksChromatogramPopUp(mass, retentionTime, response){
				var $modal = $("#full-width");
				var modalBody = $modal.find('.modal-body');
				var modalFooter = $modal.find('.modal-footer');
				var modalHeader = $modal.find('.modal-header');

				$(modalHeader).empty();
				$(modalLabel).empty();
				$(modalBody).empty();
				$(modalFooter).empty();

				$('<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>').appendTo($(modalFooter));
				$('<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button><h3 id="myModalLabel"></h3>').appendTo($(modalHeader));
				var modalLabel = $modal.find('#myModalLabel');
				$(modalLabel).text("All peak chromatograms RT: "+parseFloat(retentionTime).toFixed(1)+"s (+/- "+rtwindow+"s) Mass: " + parseFloat(mass).toFixed(4) + " (+/- " + parseFloat(ppm) + " ppm)");
				var chartWidth = $modal.width()/4;
				var j = 0;
				for (var i=1;i<response.length;i++){
					if (j==0){
						var row = $('<div class="row" style="margin-left:0px;margin-bottom:0px"></div>');
					}
					var div = $('<div class="span3" style="margin:0px;width:'+chartWidth+'px"></div>');
					$(div).highcharts({
						credits : {
    						enabled : false
    					},
						chart: {
			                zoomType: 'x',
			                width: chartWidth,
			                height: 300,
			                backgroundColor: '#ffffff',
			                plotBackgroundColor: null,
			                plotBorderWidth: null,
			                plotShadow: false,
			            },
			            title: {
			                text: response[i][0]
			            },
			            // subtitle: {
			            //     text: 'Mass: '+parseFloat(mass).toFixed(4)+' ppm: '+ppm
			            // },
			            xAxis: {
			                title: {
			                    text: 'Retention time (s)'
			                },
	                		showLastLabel: true
			            },
			            yAxis: {
			                title: {
			                    text: 'Measured abundance'
			                },
			                min: 0,
			            },
			            legend: {
			                enabled: false
			            },
			            series: [{
			                type: 'area',
			                name: response[i][0],
			                data : response[i][1]
			            }],
			    		plotOptions: {
			                area: {
			                    marker: {
			                        enabled: false,
			                        symbol: 'circle',
			                        radius: 2,
			                        states: {
			                            hover: {
			                                enabled: true
			                            }
			                        }
			                    },
			                    lineWidth: 1,
			                    shadow: false,
			                    states: {
			                        hover: {
			                            lineWidth: 1
			                        }
			                    },
			                    threshold: null
			                },
			                series: {
                				fillOpacity: 0.1
	            			}
			            },



		    		});
					$(div).appendTo($(row));
					j += 1;
					if (i == response.length-1 && j != 4){
						$(row).appendTo($(modalBody));
					}
					if (j == 4){
						$(row).appendTo($(modalBody));
						j = 0;
					}
				}
				$(modalBody).css('overflow', 'auto');
				var windowHeight = $(window).height() - (25 * $(window).height() / 100);
				$(modalBody).css('max-height', windowHeight);
				$modal.modal();
			}

		});
		</script>
	</head>
	<body style="padding-top:0px;" data-spy="scroll" data-target=".bs-docs-sidenav">
		<div id="main-pimp-navbar" class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            			<span class="icon-bar"></span>
            			<span class="icon-bar"></span>
            			<span class="icon-bar"></span>
					</a>
					<a class="brand" href="{% url 'index' %}">PiMP</a>
					<div class="nav-collapse">
						<ul class="nav">
							{% if user.is_authenticated %}
							<li><a href="{% url 'project_summary' %}">My projects</a></li>
							<li><a href="{% url 'profile' %}">My account</a></li>
                            <li><a href="{% url 'userguide' %}">User guide</a></li>
							<li><a href="{% url 'auth_logout' %}">Logout</a></li>
							{% else %}
							<li><a href="{% url 'auth_login' %}">Login</a></li>
							{# <li><a href="{% url 'registration_register' %}">Register</a></li> #}
                            <li><a href="{% url 'userguide' %}">User guide</a></li>
							{% endif %}
							{# <li><a href="{% url 'about' %}">About</a></li> #}
						</ul>
					</div>
				</div>
			</div>
		</div>
		<header id="subheader" class="subhead" style="padding-top:40px">
			<div id="serch-banner" class="container" style="padding:5px;">
				<!-- <div class="span2">
					<a href=""><img src="{{ STATIC_URL }}img/PiMP_logo.png" alt="index"></a>
				</div> -->
				<div class="row" style="height:65px;">
					<div class="span3" style="margin-top: 14px;margin-bottom: 5px;">
						<form class="navbar-search pull-left">
	  						<input type="text" class="search-query" placeholder="Search" id="search" style="max-width: 150px;">
							<img src="{{ STATIC_URL }}img/search-icon.png" alt="search" style="margin-left:10px;">
						</form>
					</div>
					<div class="span3" style="margin-top: 22px;">
						<div id="metabolites_table_super_pathway_selector_div" style="margin-top: -3px;margin-right: 15px;float: right;width: 200px;display: none;">
							<select id="metabolites_table_super_pathway_selector">
								<option></option>
							</select>
						</div>
					</div>
					<div class="span3" style="margin-top: 22px;">
						<div id="metabolites_table_pathway_selector_div" style="margin-top: -3px;margin-right: 15px;float: right;width: 200px;display: none;">
							<select id="metabolites_table_pathway_selector">
								<option></option>
							</select>
						</div>
					</div>
					<div class="span3" style="margin-top: 15px;">
						<p style="float:right;">{{ user.first_name }} {{ user.last_name }}</p>
					</div>
				</div>
			</div>
			<div class="navtable" style="background-color:#f5f5f5;width:100%;padding:0px;text-align:center;height:40px;">
				<div id="polyomics_logo" style="float:left;background-color:#276EEE;height:40px;width:43px;display:none;"><img src="{{ STATIC_URL }}img/logo_white_small.png" alt="polyomics" style="margin-top: 4px;margin-right: 1px;"></div>
				<div id="tool_button"><img src="{{ STATIC_URL }}img/tool_icon.png" alt="tools"><span id="tool_button_text">Tools</span><img src="{{ STATIC_URL }}img/down4-25.png" alt="tools"></div>
				<ul id="tabnav" class="nav navbar-nav tabnav" style="margin:0px;float:none;display:inline-block;height:40px;">
					<li id="summary-li" class="active" style="float:left;margin:0px;height:37px;"><a href="#summary" style="float:left;margin:0px;">Summary</a></li>
                    <li id="metexplore-li" style="float:left;margin:0px;height:37px;margin-left:20px;" class="hidden-tab"><a href="#metexplore-viz" style="float:left;margin:0px;">Network</a></li>
					<li id="metabolites-li" style="float:left;margin:0px;height:37px;margin-left:20px;"><a href="#metabolites" style="float:left;">Metabolites</a></li>
					<li id="pathway-li" style="float:left;margin:0px;height:37px;margin-left:20px;"><a href="#pathway" style="float:left;">Metabolic Maps</a></li>
					<li id="comparison-li" style="float:left;margin:0px;height:37px;margin-left:20px;"><a href="#comparison" style="float:left;">Comparison</a></li>
					<li id="peaks-li" style="float:left;margin:0px;height:37px;margin-left:20px;"><a href="#peaks" style="float:left;">Peaks</a></li>
					<li class="dropdown" style="float:left;margin:0px;height:37px;margin-left:20px;">
						<a class="dropdown-toggle" data-toggle="dropdown" href="#">More<b id="nav-bar-caret" class="caret"></b></a>
						<ul class="dropdown-menu" id="dropdown-comparison-menu" style="min-width:100px;">
							{% for comparison in comparisons %}
								<li id="comparison{{ comparison.id }}-li" style="margin:0px;"><a href="#comparison{{ comparison.id }}" class="dropdown-comparison-menu-a" style="float:left;">{{ comparison.attributecomparison_set.all.0.attribute.name }} / {{ comparison.attributecomparison_set.all.1.attribute.name }}</a></li>
					        {% endfor %}
						</ul>
					</li>
				</ul>
				<div id="search2" style="position: absolute;margin-left: 15px;display:none;right: 65px;top: 0px;">
					<input type="text" class="search-query" style="margin-top: 5px;width: 95px;font-size: 13px;" placeholder="Search" id="search2-input"></div>
				<div id="right-side-button"><img id="right-arrow" class="show-right" src="{{ STATIC_URL }}img/down4-25.png" alt="tools"></div>
			</div>
		</header>
		<div id="tool_menu_bar" class="left_menu">
			<div class="tool_menu_inner">
				<div class="home_button" id="home_button"><div style="padding-top:10px"><img src="{{ STATIC_URL }}img/home.png" alt="tools" ><span id="tool_button_text">Home</span></div>
				</div>
				<div class="inner_button" id="preferences"><div style="padding-top:10px"><img src="{{ STATIC_URL }}img/preference_icon.png" alt="tools" ><span id="tool_button_text">Preferences</span></div>
				</div>
				<div class="inner_button" id="enlarge"><div style="padding-top:10px"><img src="{{ STATIC_URL }}img/fullscreen_icon.png" alt="tools" ><span id="tool_button_text">Full screen</span></div>
				</div>
				<!-- <div class="inner_button"><div style="padding-top:10px"><img src="{{ STATIC_URL }}img/cluster_icon.png" alt="tools" ><span id="tool_button_text">Fragmentation</span></div>
				</div> -->
				<!-- <div class="inner_button"><div style="padding-top:10px"><img src="{{ STATIC_URL }}img/sort_icon.png" alt="tools" ><span id="tool_button_text">Sort</span></div>
				</div>
				<div class="inner_button"><div style="padding-top:10px"><img src="{{ STATIC_URL }}img/pca_icon.png" alt="tools" ><span id="tool_button_text">PCA</span></div>
				</div> -->
				<!-- <div class="inner_button" id="metexplore"><div style="padding-top:10px"><img src="{{ STATIC_URL }}img/Logo_Metexplore_20px.png" alt="tools" ><span id="tool_button_text">MetExplore</span></div>
				</div> -->
                <div class="inner_button" id="metexplore"><div style="padding-top:10px"><img src="{{ STATIC_URL }}img/Logo_Metexplore_20px.png" alt="tools" ><span id="tool_button_text">Network analysis</span></div>
                </div>
				<div class="side_footer">
					<!-- <span id="tool_button_text">Privacy</span><span id="tool_button_text">Credits</span> -->
				</div>
			</div>
		</div>
		<div id="main-container" class="container" style="bottom:0px;margin:0px;width:100%;position:absolute;top:155px;z-index:6;">
			<div class="tab-content" id="general-tab-content">
				<div id="summary" class="tab-pane active">
                    <div class="subnavtable" style="width:100%;padding:0px;text-align:center;height:40px;background-color: rgb(227, 236, 253);">
                        <ul id="subtabnav" class="nav navbar-nav tabnav" style="margin:0px;float:none;display:inline-block;height:40px;">
                            <li id="subsummary-li" class="active" style="float:left;margin:0px;height:37px;"><a href="#subsummary" style="float:left;margin:0px;">Summary</a></li>
                            <li id="qc-li" style="float:left;margin:0px;height:37px;margin-left:20px;"><a href="#qc" style="float:left;">Quality control</a></li>
                            <li id="results-li" style="float:left;margin:0px;height:37px;margin-left:20px;"><a href="#results" style="float:left;">Results</a></li>
                        </ul>
                    </div>
                    <div class="container" style="bottom:0px;margin:0px;width:100%;">
                        <div class="tab-content">
                            <div id="subsummary" class="tab-pane active">
            					<div class="row" style="margin:0px;">
            						<div class="span12" style="width:100%;margin:0px;">
            							<div class='home-title' style='text-align:center;'>
            								<h2 style="margin-top:0px">PiMP summary report</h2>
            								<h3 style="margin-bottom:0px;">Project: {{ project.title }}</h3>
            							</div>
            						</div>
            					</div>
            					<div class="row" style="margin-left:0px;">
            						<div class="row-fluid">
                                        <div class="row">
                                            <div class="span2"></div>
                    							<div class="span8">
                    								<!-- Just for test -->
                    								<div class="row-fluid">
                    									<h3>Study</h3>
                    									<p>A metabolomic analysis was performed on {{ sample_list|samplelistlength }} samples consisting of {{ member_list|length }} groups: {% for member in member_list %}{% if not forloop.first and not forloop.last %},{% elif forloop.last %} and{% endif %} {{ member.name }}{% endfor %}. </p>

                    									{% with member_list|sampletable as sampledescriptiontable %}
                    										<table class="summary-table">
                    											<thead>
                    										        <tr>
                    										            <th style="border-top: 2px solid rgba(255, 255, 255, 0);"></th>
                    										            {% for member in member_list %}
                    										            <th>{{ member.name }}</th>
                    										            {% endfor %}
                    										        </tr>
                    										    </thead>
                    										    <tbody>
                    										    	{% for row in sampledescriptiontable %}
                    										    	<tr>
                    										    		<th>Replicate {{ forloop.counter }}</th>
                    										    		{% for samplename in row %}
                    										    			{% if samplename %}
                    										    				<td>{{ samplename }}</td>
                    										    			{% else %}
                    										    				<td></td>
                    										    			{% endif %}
                    										    		{% endfor %}
                    										    	</tr>
                    										    	{% endfor %}
                    											</tbody>
                    										</table>
                    									{% endwith %}

                    									<p>{{ comparisons|length }} pairwise comparison{{ comparison|length|pluralize }} were performed:
                    											{% for comparison in comparisons %}
                    											<li>{{ comparison.attributecomparison_set.all.0.attribute.name }} relative to {{ comparison.attributecomparison_set.all.1.attribute.name }}</li>
                    											{% endfor %}
                    										</ul>
                    									</p>


                    									<!--<div style="margin-left:30px;">
                    										<h4>Description & hypothesis</h4>
                    										{% if project.description %}
                    										<p>{{ project.description }}</p>
                    										{% else %}
                    										<p>Data not available</p>
                    										{% endif %}
                    									</div>-->

                    									<!--<h3>LCMS</h3>
                    									<p>Samples were separated using a <b>ZIC-HILIC/ZIC-pHILIC</b> column.</p>
                    									<p>The solvents used were:
                    										<ul>
                    											<li>A: water with 20mM ammonium carbonate.</li>
                    											<li>B: acetonitrile.</li>
                    										</ul>
                    									</p>
                    									<p>The gradient ran from 20% A to 80% A in 15 minutes, with a step to 95% A for 2 minutes followed by equilibration for 7 minutes at 20% A.</p>
                    									<p>The chromatography system was coupled to an orbitrap <b>Exactive/Q-Exactive</b> running at <b>50,000/70,000</b> resolution in positive/negative switching mode.</p>-->

                    									<h3>Data processing</h3>
                    									<p>The peaks for each sample were called and retention time corrected using the Obiwarp (Prince &amp; Marcotte&#44; 2006) algorithm.  Filtering was carried out on the basis of noise, number of values present etc.</p>

                                                        <h4>Metabolic Maps</h4>
                                                        <p>The identified and annotated metabolites mapped to {{pathway_list|length}} KEGG metabolic maps. {{pathway_list|significant_pathway_coverage}} metabolic maps had greater than 75% coverage.</p>
                    									<!--<div style="margin-left:30px;">
                    										<h4>Softwares and libraries</h4>
                    										<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                    										<h4>Peak picking</h4>
                    										<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                    										<h4>Retention time correction</h4>
                    										<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                    										<h4>Filters</h4>
                    										<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                    										<h4>Identification</h4>
                    										<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                    									</div>-->

                    									<!--<h3>Normalization/transformation</h3>
                    									<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>-->
                                                    </div>
                                                </div>
                                            <div class="span2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="qc" class="tab-pane">
                                <div class="row" style="margin:0px;">
                                    <div class="span12" style="width:100%;margin:0px;">
                                        <div class='home-title' style='text-align:center;'>
                                            <h2 style="margin-top:0px">PiMP summary report</h2>
                                            <h3 style="margin-bottom:0px;">Project: {{ project.title }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" style="margin-left:0px;">
                                    <div class="row-fluid">
                                        <div class="span2"></div>
                                            <div class="span8" >
                                                <!-- Just for test -->
                                                <div class="row-fluid">
                									<h3>Quality Control</h3>
                									<p>Principal Component Analysis</p>
                									<div class="" id="pca_test"></div>

                									<p>Total Ion Chromatograms</p>
                									{% for member in member_list %}
                                                    <div class="row">
                									   <div class="span12" id="tic_pos{{member.id}}"></div>
                                                    </div>
                									{% endfor %}
                									{% for member in member_list %}
                                                    <div class="row">
                									   <div class="span12" id="tic_neg{{member.id}}"></div>
                                                    </div>
                									{% endfor %}
                                                </div>
                                            </div>
                                        <div class="span2"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="results" class="tab-pane">
                                <div class="row" style="margin:0px;">
                                    <div class="span12" style="width:100%;margin:0px;">
                                        <div class='home-title' style='text-align:center;'>
                                            <h2 style="margin-top:0px">PiMP summary report</h2>
                                            <h3 style="margin-bottom:0px;">Project: {{ project.title }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" style="margin-left:0px;">
                                    <div class="row-fluid">
                                        <div class="span2"></div>
                                            <div class="span8">
                                                <!-- Just for test -->
                                                <div class="row-fluid">
                									<h3>Results</h3>
                									<!-- <p>Following processing the peaks were annotated/identified on the basis of mass and mass/retention time match to known standards respectively. </p> -->

                									<h4>Identification</h4>
                									<p>Following processing the peaks were annotated/identified on the basis of mass and mass/retention time match to known standards respectively. {{ dataset|number_unique_compounds:True }} unique compounds matched to a known standard.</p>

                									<h4>Comparison</h4>
                									<p>{{ comparisons|length }} group-wise comparisons were undertaken to identify differences (fold changes). Each fold change has associated significance statistics.  Peaks with an adjusted p-value less than 0.05 were considered significant. The tables below for each comparison show the statistically significant identified and annotated peaks along with their associated log fold changes.</p>

                									{% for comparison,comparison_hits in comparison_hits_list.items %}
                									<h5>{{ comparison.attributecomparison_set.all.0.attribute.name }} / {{ comparison.attributecomparison_set.all.1.attribute.name }}</h5>

                										{% if comparison_hits.0 and comparison_hits.1 %}
                											{% if comparison_hits.0|length > 10 %}
                												<p>{{ comparison_hits.0|length }} identified compounds are significantly changing. The 10 most significant hits are displayed below.</p>
                											{% else %}
                												<p>{{ comparison_hits.0|length }} identified compound{{ comparison_hits.0|length|pluralize }} {{ comparison_hits.0|length|pluralize:"is,are" }} significantly changing, please see the list below.</p>
                											{% endif %}
                											<table class="summary-table">
                												<thead>
                											        <tr>
                											            <th>Compound</th>
                											            <th>Peak</th>
                											            <th>Log FC</th>
                											            <th>P-Value</th>
                											            <th>Adj. P-Value</th>
                											            <th>{{ comparison_hits.0.0.2.0.0 }} intensity</th>
                												        <th>{{ comparison_hits.0.0.2.1.0 }} intensity</th>
                											            <th>Intensity</th>
                											        </tr>
                											    </thead>
                											    <tbody>
                											    	{% for compound in comparison_hits.0|slice:":10" %}
                											    	<tr>
                											    		<th>{% for name in compound.1 %}{{ name }}<br>{% endfor %}</th>
                											    		<td>{{ compound.0.peak.secondaryId }}</td>
                											    		<td>{{ compound.0.logFC|floatformat:"-2" }}</td>
                											    		<td>{{ compound.0.pValue|stringformat:".2g" }}</td>
                											    		<td>{{ compound.0.adjPvalue|stringformat:".2g" }}</td>
                											    		<td>{{  compound.2.0.1|floatformat:"0" }}</td>
                												    	<td>{{  compound.2.1.1|floatformat:"0" }}</td>
                											    		<td data-sparkline="{{  compound.2.0.1|floatformat:'0' }}, {{  compound.2.1.1|floatformat:'0' }} ; {{  compound.2.0.0 }} ; {{  compound.2.1.0 }} ; column"></td>
                											    	</tr>
                											    	{% endfor %}
                											    </tbody>
                											</table>
                											{% if comparison_hits.1|length > 10 %}
                												<p>{{ comparison_hits.1|length }} annotated peaks are significantly changing. The 10 most significant hits are displayed below. Click 'Show all' to see the 50 most significant hits.</p>
                												<div class="summary_table_container" id="summary_table_container-{{ forloop.counter }}">
                											{% else %}
                												<p>{{ comparison_hits.1|length }} annotated peak{{ comparison_hits.1|length|pluralize }} {{ comparison_hits.0|length|pluralize:"is,are" }} significantly changing, please see the list below.</p>
                											{% endif %}
                											<table class="summary-table">
                													<thead>
                												        <tr>
                												            <th>Peak</th>
                												            <th>Log FC</th>
                												            <th>P-Value</th>
                												            <th>Adj. P-Value</th>
                												            <th>{{ comparison_hits.1.0.1.0.0 }} intensity</th>
                												        	<th>{{ comparison_hits.1.0.1.1.0 }} intensity</th>
                												            <th>Intensity</th>
                												        </tr>
                												    </thead>
                												    <tbody>
                												    	{% for compound in comparison_hits.1|slice:":50" %}
                												    	<tr>
                												    		<th class="peak_id" tooltip-append-to-body="true" data-toggle="tooltip" title="Click for compounds" data-container="body">{{ compound.0.peak.secondaryId }}</th>
                												    		<td>{{ compound.0.logFC|floatformat:"-2" }}</td>
                											    			<td>{{ compound.0.pValue|stringformat:".2g" }}</td>
                											    			<td>{{ compound.0.adjPvalue|stringformat:".2g" }}</td>
                											    			<td>{{  compound.1.0.1|floatformat:"0" }}</td>
                												    		<td>{{  compound.1.1.1|floatformat:"0" }}</td>
                												    		<td data-sparkline="{{  compound.1.0.1|floatformat:'0' }}, {{  compound.1.1.1|floatformat:'0' }} ; {{  compound.1.0.0 }} ; {{  compound.1.1.0 }} ; column"></td>
                												    	</tr>
                												    	{% endfor %}
                												    </tbody>
                												</table>
                											{% if comparison_hits.1|length > 10 %}
                											</div>
                											<p style="text-align: center;"><span class="summary_table_expand_button" id="summary_table_expand_button-{{ forloop.counter }}">Show all</span></p>
                											{% endif %}
                										{% elif comparison_hits.0 and not comparison_hits.1 %}
                											{% if comparison_hits.0|length > 10 %}
                												<p>{{ comparison_hits.0|length }} identified compounds are significantly changing, below is display the 10 most significant hits.</p>
                											{% else %}
                												<p>{{ comparison_hits.0|length }} identified compound{{ comparison_hits.0|length|pluralize }} {{ comparison_hits.0|length|pluralize:"is,are" }} significantly changing, please see the list below.</p>
                											{% endif %}
                											<table class="summary-table">
                													<thead>
                												        <tr>
                												            <th>Compound</th>
                												            <th>Peak</th>
                												            <th>Log FC</th>
                												            <th>P-Value</th>
                												            <th>Adj. P-Value</th>
                												            <th>{{ comparison_hits.0.0.2.0.0 }} intensity</th>
                												            <th>{{ comparison_hits.0.0.2.1.0 }} intensity</th>
                												            <th>Intensity</th>
                												        </tr>
                												    </thead>
                												    <tbody>
                												    	{% for compound in comparison_hits.0|slice:":10" %}
                												    	<tr>
                													    	<th>{% for name in compound.1 %}{{ name }}<br>{% endfor %}</th>
                												    		<td>{{ compound.0.peak.secondaryId }}</td>
                												    		<td>{{ compound.0.logFC|floatformat:"-2" }}</td>
                												    		<td>{{ compound.0.pValue|stringformat:".2g" }}</td>
                												    		<td>{{ compound.0.adjPvalue|stringformat:".2g" }}</td>
                												    		<td>{{  compound.2.0.1|floatformat:"0" }}</td>
                												    		<td>{{  compound.2.1.1|floatformat:"0" }}</td>
                												    		<td data-sparkline="{{  compound.2.0.1|floatformat:'0' }}, {{  compound.2.1.1|floatformat:'0' }} ; {{  compound.2.0.0 }} ; {{  compound.2.1.0 }} ; column"></td>
                												    	</tr>
                												    	{% endfor %}
                												    </tbody>
                												</table>
                											<p>No statistically significant annotated peak has been found for this comparison.Significant changes are calculated using adjusted p-values, for more information on this comparison please refer to the single comparison tab on the top right of the window.</p>

                										{% elif not comparison_hits.0 and comparison_hits.1 %}
                										<p>No statistically significant identified compounds have been found for this comparison. Significant changes are calculated using adjusted p-values, for more information on this comparison please refer to the single comparison tab on the top right of the window.</p>

                											{% if comparison_hits.1|length > 10 %}
                												<p>{{ comparison_hits.1|length }} annotated peaks are significantly changing, below is display the 10 most significant hits.</p>
                											{% else %}
                												<p>{{ comparison_hits.1|length }} annotated peak{{ comparison_hits.1|length|pluralize }} {{ comparison_hits.0|length|pluralize:"is,are" }} significantly changing, please see the list below.</p>
                											{% endif %}
                											<table class="summary-table">
                													<thead>
                												        <tr>
                												            <th>Peak</th>
                												            <th>Log FC</th>
                												            <th>P-Value</th>
                												            <th>Adj. P-Value</th>
                												            <th>{{ comparison_hits.1.0.1.0.0 }} intensity</th>
                												        	<th>{{ comparison_hits.1.0.1.1.0 }} intensity</th>
                												            <th>Intensity</th>
                												        </tr>
                												    </thead>
                												    <tbody>
                												    	{% for compound in comparison_hits.1|slice:":10" %}
                												    	<tr>
                												    		<th class="peak_id">{{ compound.0.peak.secondaryId }}</th>
                												    		<td>{{ compound.0.logFC|floatformat:"-2" }}</td>
                											    			<td>{{ compound.0.pValue|stringformat:".2g" }}</td>
                											    			<td>{{ compound.0.adjPvalue|stringformat:".2g" }}</td>
                											    			<td>{{  compound.1.0.1|floatformat:"0" }}</td>
                												    		<td>{{  compound.1.1.1|floatformat:"0" }}</td>
                												    		<td data-sparkline="{{  compound.1.0.1|floatformat:'0' }}, {{  compound.1.1.1|floatformat:'0' }} ; {{  compound.1.0.0 }} ; {{  compound.1.1.0 }} ; column"></td>
                												    	</tr>
                												    	{% endfor %}
                												    </tbody>
                												</table>

                										{% else %}
                										<p>No statistically significant change has been found for this comparison. Significant changes are calculated using adjusted p-values, for more information on this comparison please refer to the single comparison tab on the top right of the window.</p>

                										{% endif %}

                									<p>The volcano plot below display significance versus fold-change on the y- and x-axes, respectively. This specific plot is constructed by plotting the negative log (base 10) of the <b>adjusted p-value</b> on the y-axis.</p>
                									<p>For more information on the <b>p-value</b> please refer to the single comparison tab on the top right of the window</p>
                									<div class="volcano-plot" id="comparison{{ comparison.id }}-volcano-plot"></div>
                									{% endfor %}

                									<!--<h3>Disclaimer</h3>
                									<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>-->
                								</div>
                							</div>
                                        <div class="span2"></div>
            						</div>
            					</div>
                            </div>
                        </div>
                    </div>
				</div>
                <div id="metexplore-viz" class="tab-pane hidden-tab">
                    <div class="row" style="margin:0px;height:100%;overflow: auto;margin-bottom:0px;">
                        <div class="span12" style="width:100%;margin:0px;height:100%;">
                            <div id="metexplore-container" style="height: 100%;">
                            </div>
                        </div>
                    </div>
                </div>
				<div id="metabolites" class="tab-pane">
					<div class="row" style="margin-left:0px;height:100%;overflow: auto;margin-bottom:0px;">
						<div class="myspan9" style="height:100%;">
							<div class="row-fluid" style="overflow: auto;height: 100%;position: relative;">
								<div class="spreadsheet-content" style="overflow: auto;height: 100%;position: relative;">
									<table id="metabolites-table" class="table table-striped">
						              <thead>
						                <tr>
						                  <th rowspan="1">Compound id</th>
						                  <th rowspan="1">Peak ID</th>
						                  <th rowspan="1">Name</th>
						                  <th rowspan="1">Formula</th>
						                  <th rowspan="1">SuperPathway</th>
										  <th rowspan="1">Pathway</th>
											{% for sample in sample_list_union %}
											<th rowspan="1">{{ sample.name }}</th>
											{% endfor %}
{#										  {% for member in member_list %}#}
{#										  <th rowspan="2" class="average-column">Average {{ member.name }}</th>#}
{#										  {% endfor %}#}
                                          {% for comparison in comparisons %}
                                          <th rowspan="1">logFC {{ comparison.attributecomparison_set.all.0.attribute.name }} / {{ comparison.attributecomparison_set.all.1.attribute.name }}</th>
                                          {% endfor %}
										  <th rowspan="1">Identification</th>


						                 </tr>
						              </thead>
						            </table>
								</div>
							</div>
						</div>
						<div class="myspan3" style="height:100%;">
							<div class="row-fluid">
								<div class="right-side-bar-inner">
								</div>
							</div>
						</div>
					</div>
				</div>
				<div id="pathway" class="tab-pane">
					<div class="row" style="margin-left:0px;height:100%;overflow: auto;margin-bottom:0px;">
						<div class="myspan9" style="height:100%;">
							<div class="row-fluid" style="overflow: auto;height: 100%;position: relative;">
								<div class="spreadsheet-content" style="overflow: auto;height: 100%;position: relative;">
									<table id="pathway-table" class="table table-striped">
						              <tbody>
						              	{% for pathway in pathway_list %}
						              	<tr map="{{ pathway.0.secondaryId }}/{% for id in pathway.4.1 %}{{ id }}%09blue/{% endfor %}{% for id in pathway.4.0 %}{{ id }}%09green/{% endfor %}"><td>{{ pathway.0.name }}</td>
						              		<td>{{ pathway.0.id }}</td>
						              		<td>{{ pathway.5 }}</td>
						              		<td>{{ pathway.2 }}</td>
						              		<td>{{ pathway.1 }}</td>
						              		<td>{{ pathway.3 }}</td></tr>
						              	{% endfor %}
						              </tbody>
						              <!-- test -->
						            </table>
								</div>
							</div>
						</div>
						<div class="myspan3" style="height:100%;">
							<div class="row-fluid">
								<div class="right-side-bar-inner">
								</div>
							</div>
						</div>
					</div>
				</div>
				{% with comparison|timer_start as time %}
				<div id="comparison" class="tab-pane">
					<div class="row" style="margin-left:0px;height:100%;overflow: auto;margin-bottom:0px;">
						<div class="myspan9" style="height:100%;">
							<div class="row-fluid" style="overflow: auto;height: 100%;position: relative;">
								<div class="spreadsheet-content" style="overflow: auto;height: 100%;position: relative;">
									<table id="comparison-table" class="table table-striped">
						              <thead>
						                <tr>
						               	  <th>Peak id</th>
						                  {% for comparison in comparisons %}
						                  <th >{{ comparison.attributecomparison_set.all.0.attribute.name }} / {{ comparison.attributecomparison_set.all.1.attribute.name }} (logfc)</th>
						                  {% endfor %}
						                 </tr>
						              </thead>
						              <tbody>
						              	{% for peak in all_comparison_info %}
						              	<tr><td>{{ peak.0.0 }}</td>
						              		{% for comp in peak %}
						              		<td{% autoescape off %}{% if comp.2 <= 0.05 %}{{ comp.1|get_fold_change_colour }}{% endif %}{% endautoescape %}>{% if comp.1 != 0 %}{{ comp.1|floatformat:"-2" }}{% else %}NA{% endif %}</td>
						              		{% endfor %}
						              	</tr>
						              	{% endfor %}
{#						              	{% for peak in peak_comparison_list %} #}
{#						              	<tr><td>{{ peak.secondaryId }}</td> #}
{#						              		{% for comp in peak.peakdtcomparison_set.all %} #}
{#						              		 <td{% autoescape off %}{% if comp.is_significant %}{{ comp|fold_change_colour }}{% endif %}{% {#endautoescape %}>{% if comp.logFC != 0 %}{{ comp.logFC|floatformat:"-2" }}{% else %}NA{% endif %}</td> #}
{#						              		 {% endfor %} #}
{#						              	</tr> #}
{#						                {% endfor %} #}
						              </tbody>
						            </table>
								</div>
							</div>
						</div>
						<div class="myspan3" style="height:100%;">
							<div class="row-fluid">
								<div class="right-side-bar-inner">
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- {{ time|timer_end:'Comparison Table' }} -->
				{% endwith %}

				{% with comparison|timer_start as time %}
				<div id="peaks" class="tab-pane">
					<div class="row" style="margin-left:0px;height:100%;overflow: auto;margin-bottom:0px;">
						<div class="myspan9" style="height:100%;">
							<div class="row-fluid" style="overflow: auto;height: 100%;position: relative;">
								<div class="spreadsheet-content" style="overflow: auto;height: 100%;position: relative;">
									<table id="peak-table" class="table table-striped">
						              <thead>
						                <tr>

						               	  <th rowspan="2">Peak id</th>
						                  <th rowspan="2">Mass</th>
						                  <th rowspan="2">RT</th>
						                  {% for member in member_list %}
						                  <th rowspan="1" colspan="{{ member.sample.all|length }}" style="{% if not forloop.last %}border-right: solid 1px black;{% endif %}">{{ member.name }}</th>
						                  {% endfor %}
						                  <th rowspan="2">Polarity</th>
						                 </tr>
						                 <tr>
						                  {% for sublist in sample_list %}
						                  	{% for sample in sublist %}
						                  	<th rowspan="1">{{ sample.name }}</th>
						                  	{% endfor %}
						                  {% endfor %}
						                </tr>
						              </thead>
						            </table>
								</div>
							</div>
						</div>
						<div class="myspan3" style="height:100%;">
							<div class="row-fluid">
								<div class="right-side-bar-inner">
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- {{ time|timer_end:'Peak Table' }} -->
				{% endwith %}

				{% with comparison|timer_start as time %}
				{% for comparison in comparison_info %}
    			<div id="comparison{{ comparison.0.id }}" class="tab-pane">
					<div class="row" style="margin-left:0px;height:100%;overflow: auto;margin-bottom:0px;">
						<div class="myspan9" style="height:100%;">
							<div class="row-fluid" style="overflow: auto;height: 100%;position: relative;">
								<div class="spreadsheet-content" style="overflow: auto;height: 100%;position: relative;">
									<table id="comparison{{ comparison.0.id }}-table" class="table table-striped">
						              <thead>
						              	<tr class="row-filter">
						               	  <th class="column-filter" style="width: 20%;clear:both;vertical-align:top;">ID</th>
						                  <th class="column-filter" style="width: 20%;clear:both;vertical-align:top;"></th>
						                  <th class="column-filter" style="width: 20%;clear:both;vertical-align:top;"></th>
						                  <th class="column-filter" style="width: 20%;clear:both;vertical-align:top;"></th>
						                  <th class="column-filter" style="width: 20%;clear:both;vertical-align:top;"></th>
						                 </tr>
						                <tr>
						               	  <th>Peak id</th>
						                  <th>Log FC</th>
						                  <th>P-value</th>
						                  <th>Adjusted P-value</th>
						                  <th>Log Odds</th>
						                 </tr>
						              </thead>
						            </table>
								</div>
							</div>
						</div>
						<div class="myspan3" style="height:100%;">
							<div class="row-fluid">
								<div class="right-side-bar-inner">
								</div>
							</div>
						</div>
					</div>
				</div>
				{% endfor %}
				<!-- {{ time|timer_end:'Single Comparison Table' }} -->
				{% endwith %}
			</div>
		</div>
		<div id="full-width" class="modal container hide fade" tabindex="-1" style="top: 10%">
			  <div class="modal-header">
			    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
			    <h3 id="myModalLabel">Kegg test</h3>
			  </div>
			  <div class="modal-body" style="padding: 0px;">
			  </div>
			  <div class="modal-footer">
			    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
			  </div>
		</div>
		<div id="small-window" class="modal hide fade" style="top: 10%;">
		  <div class="modal-header">
		    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		    <h3>Modal header</h3>
		  </div>
		  <div class="modal-body">
		    <p>One fine body…</p>
		  </div>
		  <div class="modal-footer">
		    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
		  </div>
		</div>
	</body>
</html>
